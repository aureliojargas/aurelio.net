<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<meta charset="utf-8">
	<title>WordPress: Como adicionar campos no formulário de comentários | Aurelio.net</title>

	<link rel="shortcut icon" href="/favicon.ico">
	<meta name="author" content="Aurelio Jargas">
	<meta name="generator" content="Jekyll">

	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">


	<meta name="theme-color" content="#27ae60" /><!--same as #header background color-->
	<link rel="stylesheet" type="text/css" href="/assets/reset.css">
	<link rel="stylesheet" type="text/css" href="/assets/bars2.css">
	<link rel="stylesheet" type="text/css" href="/assets/2014.css">
	<link rel="stylesheet" type="text/css" href="/assets/monokai.css">
	<link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
	

	<link rel="alternate" type="application/rss+xml" title="Aurelio.net - Feed RSS" href="/feed/" />

	<link rel="canonical" href="https://aurelio.net/wordpress/adicionar-campos-formulario-comentarios/" />






	<!-- Open Graph Tags - http://ogp.me/ -->
	<meta property="og:type" content="article" />
	<meta property="og:title" content="WordPress: Como adicionar campos no formulário de comentários" />
	<meta property="og:url" content="https://aurelio.net/wordpress/adicionar-campos-formulario-comentarios/" />
	<meta property="og:image" content="http://www.gravatar.com/avatar/e583bca48acb877efd4a29229bf7927f" />
	<meta property="og:site_name" content="Aurelio.net" />

	<!-- Google Analytics -->
	<script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	    ga('create', 'UA-280222-1', 'auto');
	    ga('send', 'pageview');
	</script>


    <!-- AdSense auto ads -->
    <script data-ad-client="ca-pub-0009608813278754" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


</head>
<body>



<div id="header" class="bar">
	<div class="wrapper">

		<div id="site-title">
			<a href="/">Aurelio.net</a>
		</div>

		<ul id="social-icons">
			<li>
				<a href="http://twitter.com/oreio" title="Siga-me no Twitter: @oreio"
					><span class="fa-stack fa-lg"
					><i class="fa fa-circle fa-stack-2x"></i
					><i class="fa fa-twitter fa-stack-1x"></i></span></a>
			</li>
			<li>
				<a href="https://www.youtube.com/user/aureliojargas" title="Veja meus vídeos no YouTube"
					><span class="fa-stack fa-lg"
					><i class="fa fa-circle fa-stack-2x"></i
					><i class="fa fa-youtube fa-stack-1x"></i></span></a>
			</li>
			<li>
				<a href="https://github.com/aureliojargas" title="Veja meus projetos no GitHub"
					><span class="fa-stack fa-lg"
					><i class="fa fa-circle fa-stack-2x"></i
					><i class="fa fa-github-alt fa-stack-1x"></i></span></a>
			</li>
			<li>
				<a href="https://br.linkedin.com/in/aureliojargas" title="Veja meu currículo no LinkedIn"
					><span class="fa-stack fa-lg"
					><i class="fa fa-circle fa-stack-2x"></i
					><i class="fa fa-linkedin fa-stack-1x"></i></span></a>
			</li>
			<li>
				<a href="/feed/" title="Assine o Feed RSS do Aurelio.net"
					><span class="fa-stack fa-lg"
					><i class="fa fa-circle fa-stack-2x"></i
					><i class="fa fa-rss fa-stack-1x"></i></span></a>
			</li>
		</ul>
		<div style="clear:both;"></div>
	</div>
</div><!--#header-->



<div id="content" class="bar">
	<div class="wrapper">

		<div id="article-header">
			<h1><a href="/wordpress/adicionar-campos-formulario-comentarios/" title="Permalink" rel="bookmark">WordPress: Como adicionar campos no formulário de comentários</a></h1>

			
		<p class="byline">
			Escrito por 
			<a class="author" rel="author" href="/aurelio/">Aurelio Jargas</a>

			em <span class="date">15/04/2011</span>
		</p>

		</div><!--#article-header-->

		<div id="article-body">
			
	<div class="ad-blog-box-top">

		<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
		<!-- Blog 336x280 -->
		<ins class="adsbygoogle"
		     style="display:inline-block;width:336px;height:280px"
		     data-ad-client="ca-pub-0009608813278754"
		     data-ad-slot="1899275611"></ins>
		<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
		</script>

	</div>


			<p>É possível adicionar campos novos no formulário de comentários do WordPress, além dos tradicionais Nome, Email, Site e Comentário. Que outro tipo de informação você quer saber sobre os seus leitores? Pode ser o login do twitter, a idade, o sexo, número do telefone residencial, celular, ou cidade e o estado onde moram.</p>

<p>Adicionar campos não é um processo muito fácil, mas também não requer diploma em TI para executar :) Acompanhe com atenção que em poucos minutos estará tudo funcionando em seu blog.</p>

<p>Há quatro passos a serem executados:</p>

<ol>
<li>Adicionar o campo no formulário de comentários</li>
<li>Verificar o que o usuário digitou no campo</li>
<li>Salvar no banco de dados o conteúdo do campo</li>
<li>Mostrar o conteúdo do campo, seja no backend (administração), na área de comentários ou ambos.</li>
</ol>

<p>Nos exemplos seguintes, vou mostrar como adicionar dois campos ao formulário: cidade e estado. Para ficar mais elegante, o campo Estado será um menu que lista todos os estados brasileiros. Assim:</p>

<p class="figure"><img src="/img/wp/formulario-cidade-estado.png" alt="Formulário WordPress com campos para Cidade e Estado"><span>Formulário WordPress com campos para Cidade e Estado</span></p>

<h2>Passo 1 - Adicionar o campo no formulário</h2>

<p>Abra o arquivo functions.php de seu tema e adicione este código no final:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nf">add_filter</span><span class="p">(</span><span class="s1">'comment_form_default_fields'</span><span class="p">,</span> <span class="s1">'adiciona_campos'</span><span class="p">);</span>

<span class="k">function</span> <span class="n">adiciona_campos</span><span class="p">(</span><span class="nv">$campos</span><span class="p">)</span> <span class="p">{</span>

    <span class="nv">$campos</span><span class="p">[</span><span class="s1">'cidade'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'conteúdo HTML'</span><span class="p">;</span>
    <span class="nv">$campos</span><span class="p">[</span><span class="s1">'estado'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'conteúdo HTML'</span><span class="p">;</span>

    <span class="k">return</span> <span class="nv">$campos</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div>
<p>Não se preocupe (ainda) com a parte &#39;conteúdo HTML&#39;, isso colocaremos daqui dois parágrafos. Mas olhando este esqueleto, perceba que o funcionamento é simples, similar ao procedimento de <a href="/wordpress/remover-campos-formulario-comentarios/">remover campos</a>, porém preenchendo em vez de esvaziar.</p>

<p>A primeira linha liga a nossa função <code>adiciona_campos()</code> com o filtro responsável por alterar os campos padrão do formulário. A função recebe e retorna um array <code>$campos</code>, que contém os campos do formulário. Mas antes de retornar o array, é claro, faremos a mágica de adicionar os campos que precisamos: cidade e estado.</p>

<p>Tenha em mente que <code>$campos</code> é um array normal do PHP, onde cada chave representa um campo do formulário e seu conteúdo contém o código HTML completo para mostrar o campo em questão. No caso de um campo de texto como Cidade, é uma tag P que dentro tem um LABEL e um INPUT, veja:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$campos</span><span class="p">[</span><span class="s1">'cidade'</span><span class="p">]</span> <span class="o">=</span>  <span class="s1">''</span> <span class="mf">.</span>
    <span class="s1">'&lt;p class="comment-form-cidade"&gt;'</span> <span class="mf">.</span>
        <span class="s1">'&lt;label for="cidade"&gt;Cidade&lt;/label&gt; '</span> <span class="mf">.</span>
        <span class="s1">'&lt;span class="required"&gt;*&lt;/span&gt;'</span> <span class="mf">.</span>
        <span class="s1">'&lt;input id="cidade" name="cidade" type="text" value="'</span> <span class="mf">.</span>
            <span class="nf">esc_attr</span><span class="p">(</span> <span class="nv">$commenter</span><span class="p">[</span><span class="s1">'comment_cidade'</span><span class="p">]</span> <span class="p">)</span> <span class="mf">.</span>
        <span class="s1">'" size="30"'</span> <span class="mf">.</span> <span class="nv">$aria_req</span> <span class="mf">.</span> <span class="s1">' /&gt;'</span> <span class="mf">.</span>
    <span class="s1">'&lt;/p&gt;'</span><span class="p">;</span>
<span class="cp">?&gt;</span>
</code></pre></div>
<p>Você pode copiar e colar esta parte do código dentro de sua função <code>adiciona_campos()</code> e trocar a palavra <em>cidade</em> por <em>idade</em> ou <em>telefone</em>, por exemplo. Crie tantos campos quantos precisar, basta repetir o código. Se o campo for de preenchimento opcional, basta remover a linha com a tag SPAN, responsável por colocar o asterisco que indica o preenchimento obrigatório.</p>

<blockquote>
<p><del><strong>Nota:</strong> Apesar do asterisco ali no código, eu ainda não sei como forçar a verificação do campo. O comentário vai ser aprovado mesmo que o campo Cidade esteja vazio. Quando eu aprender como faz, atualizarei este texto.</del> Aprendi. Veja o novo passo 2 :)</p>
</blockquote>

<p>Para preencher o código HTML do campo Estado é a mesma coisa, porém, como quero fazer um menu com todos os estados brasileiros, usarei um SELECT no lugar do INPUT. Só isso.</p>

<p>Veja como ficou o código final, completo:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nf">add_filter</span><span class="p">(</span><span class="s1">'comment_form_default_fields'</span><span class="p">,</span> <span class="s1">'adiciona_campos'</span><span class="p">);</span>

<span class="k">function</span> <span class="n">adiciona_campos</span><span class="p">(</span><span class="nv">$campos</span><span class="p">)</span> <span class="p">{</span>

    <span class="nv">$campos</span><span class="p">[</span><span class="s1">'cidade'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span> <span class="mf">.</span>
        <span class="s1">'&lt;p class="comment-form-cidade"&gt;'</span> <span class="mf">.</span>
            <span class="s1">'&lt;label for="cidade"&gt;Cidade&lt;/label&gt; '</span> <span class="mf">.</span>
            <span class="s1">'&lt;span class="required"&gt;*&lt;/span&gt;'</span> <span class="mf">.</span>
            <span class="s1">'&lt;input id="cidade" name="cidade" type="text" value="'</span> <span class="mf">.</span>
                <span class="nf">esc_attr</span><span class="p">(</span> <span class="nv">$commenter</span><span class="p">[</span><span class="s1">'comment_cidade'</span><span class="p">]</span> <span class="p">)</span> <span class="mf">.</span>
                <span class="s1">'" size="30"'</span> <span class="mf">.</span> <span class="nv">$aria_req</span> <span class="mf">.</span> <span class="s1">' /&gt;'</span> <span class="mf">.</span>
        <span class="s1">'&lt;/p&gt;'</span><span class="p">;</span>

    <span class="nv">$campos</span><span class="p">[</span><span class="s1">'estado'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span> <span class="mf">.</span>
        <span class="s1">'&lt;p class="comment-form-estado"&gt;'</span> <span class="mf">.</span>
            <span class="s1">'&lt;label for="estado"&gt;Estado&lt;/label&gt; '</span> <span class="mf">.</span>
            <span class="s1">'&lt;span class="required"&gt;*&lt;/span&gt;'</span> <span class="mf">.</span>
            <span class="s1">'&lt;select id="estado" name="estado"&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value=""&gt;--&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="AC"&gt;AC - Acre&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="AL"&gt;AL - Alagoas&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="AM"&gt;AM - Amazonas&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="AP"&gt;AP - Amapá&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="BA"&gt;BA - Bahia&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="CE"&gt;CE - Ceará&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="DF"&gt;DF - Distrito Federal&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="ES"&gt;ES - Espírito Santo&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="GO"&gt;GO - Goiás&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="MA"&gt;MA - Maranhão&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="MG"&gt;MG - Minas Gerais&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="MS"&gt;MS - Mato Grosso do Sul&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="MT"&gt;MT - Mato Grosso&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="PA"&gt;PA - Pará&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="PB"&gt;PB - Paraíba&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="PE"&gt;PE - Pernambuco&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="PI"&gt;PI - Piauí&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="PR"&gt;PR - Paraná&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="RJ"&gt;RJ - Rio de Janeiro&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="RN"&gt;RN - Rio Grande do Norte&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="RO"&gt;RO - Rondônia&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="RR"&gt;RR - Roraima&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="RS"&gt;RS - Rio Grande do Sul&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="SC"&gt;SC - Santa Catarina&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="SE"&gt;SE - Sergipe&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="SP"&gt;SP - São Paulo&lt;/option&gt;'</span> <span class="mf">.</span>
                <span class="s1">'&lt;option value="TO"&gt;TO - Tocantins&lt;/option&gt;'</span> <span class="mf">.</span>
            <span class="s1">'&lt;/select&gt;'</span> <span class="mf">.</span>
        <span class="s1">'&lt;/p&gt;'</span><span class="p">;</span>

    <span class="k">return</span> <span class="nv">$campos</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div>
<p>Nesse ponto você já pode conferir em seu blog e os campos vão aparecer em seu formulário. Nem foi tão difícil, né?</p>

<p>Mas eles ainda são campos burros, que não guardam o que o visitante digitar. Se você preencher o formulário completo e enviar, verá que o comentário será gravado, mas as informações adicionais (cidade, estado) serão perdidas. Para evitar que isso aconteça, vamos ao próximo passo.</p>

<h2>Passo 2 - Verificar os dados</h2>

<p>Num mundo perfeito, este passo seria desnecessário. Mas infelizmente você não pode confiar cegamente em seus usuários.</p>

<ul>
<li>O usuário esqueceu de preencher um campo obrigatório?</li>
<li>O usuário colocou um valor incorreto no campo?</li>
<li>O usuário está tentando hackear o blog com um comentário malicioso?</li>
</ul>

<p>Primeiro precisamos da verificação mais básica de todas, conferir se por acaso o usuário se esqueceu de preencher algum campo obrigatório. Ainda no arquivo functions.php, basta adicionar mais algumas linhas mágicas:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nf">add_filter</span><span class="p">(</span><span class="s1">'preprocess_comment'</span><span class="p">,</span> <span class="s1">'checa_campos'</span><span class="p">);</span>

<span class="k">function</span> <span class="n">checa_campos</span><span class="p">(</span><span class="nv">$commentdata</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Verifica se os campos obrigatórios estão preenchidos</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'cidade'</span><span class="p">])</span> <span class="nf">wp_die</span><span class="p">(</span><span class="s1">'Faltou preencher a CIDADE'</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'estado'</span><span class="p">])</span> <span class="nf">wp_die</span><span class="p">(</span><span class="s1">'Faltou preencher o ESTADO'</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$commentdata</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div>
<p>O procedimento é o mesmo que fizemos no passo anterior: criar uma função nova e ligá-la a um filtro pré-definido do WordPress. Este filtro <code>preprocess_comment</code> é acionado quando o usuário envia o formulário, então aqui você tem a chance de fazer algo antes que o comentário seja gravado no banco de dados.</p>

<p>A função é bem simples, ela verifica se por acaso a cidade ou o estado estão vazios, e caso estejam, mostra uma mensagem de erro para o usuário. Alguns detalhes:</p>

<ul>
<li>O array <code>$_POST</code> guarda todos os dados do formulário.</li>
<li>A função <code>wp_die()</code> interrompe a execução do WordPress e mostra uma mensagem de erro para o usuário.</li>
<li>O array <code>$commentdata</code>, que a função recebe e retorna, pode ser ignorado pois não precisamos mexer nele.</li>
</ul>

<p>Tudo bem, com isso os campos vazios já não passam mais. Mas se em vez do nome da cidade o usuário digitar algum código malicioso para tentar confundir o sistema e invadir o seu blog?</p>

<p>Dica para a vida: <strong>Nunca confie nos dados digitados pelo usuário, NUNCA!</strong></p>

<p>Lembre-se que além, de usuários incautos, há também os hackers e os spammers. Você nunca sabe qual deles está usando seu formulário, então deve se precaver. Você deve detectar e remover qualquer tentativa de burlar as regras.</p>

<p>Aquela função <code>checa_campos()</code> que acabamos de criar para verificar se o campo é vazio é o lugar ideal para colocar todas as verificações que você precisa fazer antes confiar no conteúdo do usuário. E quer saber uma notícia muito boa? A equipe do WordPress já deixou prontas para uso as ferramentas que verificam e limpam o texto do usuário. Acompanhe:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nf">add_filter</span><span class="p">(</span><span class="s1">'preprocess_comment'</span><span class="p">,</span> <span class="s1">'checa_campos'</span><span class="p">);</span>

<span class="k">function</span> <span class="n">checa_campos</span><span class="p">(</span><span class="nv">$commentdata</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Remove possíveis textos maliciosos</span>
    <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'cidade'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">apply_filters</span><span class="p">(</span><span class="s1">'pre_comment_author_name'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'cidade'</span><span class="p">]);</span>
    <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'estado'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">apply_filters</span><span class="p">(</span><span class="s1">'pre_comment_author_name'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'estado'</span><span class="p">]);</span>

    <span class="c1">// Verifica se os campos obrigatórios estão preenchidos</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'cidade'</span><span class="p">])</span> <span class="nf">wp_die</span><span class="p">(</span><span class="s1">'Faltou preencher a CIDADE'</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'estado'</span><span class="p">])</span> <span class="nf">wp_die</span><span class="p">(</span><span class="s1">'Faltou preencher o ESTADO'</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$commentdata</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div>
<p>Há um filtro chamado <code>pre_comment_author_name</code> que é usado para limpar o conteúdo do campo Nome. Podemos usá-lo para limpar também os nossos campos novos, e é isso que o código anterior faz. Entre outras faxinas, este filtro remove códigos HTML e escapa caracteres especiais como <code>&lt;</code> e <code>&amp;</code>.</p>

<p>Se você precisar de algum outro tipo de verificação, basta adicionar ali dentro desta função. Por exemplo, se você tem um campo chamado Idade, deve verificar se o usuário digitou mesmo um número. Ou ainda, se tiver um campo CPF em seu formulário, pode usar <a href="/regex/">expressões regulares</a> para verificar se o formato do número está correto. E caso encontre qualquer problema, use a <code>wp_die()</code> para mandar uma mensagem ao usuário.</p>

<p>Agora que o formulário está validado, estamos prontos para o próximo passo.</p>

<h2>Passo 3 - Salvar no banco de dados</h2>

<p>Novamente em seu functions.php, agora adicione este código mágico no final:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nf">add_action</span><span class="p">(</span><span class="s1">'comment_post'</span><span class="p">,</span> <span class="s1">'salva_campos'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">function</span> <span class="n">salva_campos</span><span class="p">(</span><span class="nv">$comment_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">add_comment_meta</span><span class="p">(</span><span class="nv">$comment_id</span><span class="p">,</span> <span class="s1">'cidade'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'cidade'</span><span class="p">]);</span>
    <span class="nf">add_comment_meta</span><span class="p">(</span><span class="nv">$comment_id</span><span class="p">,</span> <span class="s1">'estado'</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'estado'</span><span class="p">]);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div>
<p>Mais simples impossível. Criamos uma função nova <code>salva_campos()</code> que é ligada ao filtro comment_post, assim ela será chamada no momento em que os dados do comentário forem enviados.</p>

<p>A função <code>add_comment_meta()</code> do WordPress se encarrega de guardar os dados de nossos campos adicionais lá no banco de dados. O segundo argumento será o nome do campo no banco de dados e o terceiro é o seu conteúdo, ou seja, o que o usuário digitou, obtido diretamente de <code>$_POST</code>.</p>

<blockquote>
<p>Aconselho usar sempre o mesmo nome, tanto no formulário (ID da tag INPUT ou SELECT) quanto no banco de dados. Isso evita dores de cabeça.</p>
</blockquote>

<p>Para cada campo novo que você adicionar ao formulário, adicione também uma linha nova dentro dessa função, para que seus dados sejam salvos.</p>

<p>Tá, mas e aí? Para testar, você foi lá, preencheu tudo e enviou o comentário. Como saber se os dados foram realmente gravados no banco de dados?</p>

<ul>
<li>Se você for nerd, acesse o MySQL e veja os últimos registros da tabela <code>wp_commentmeta</code>.</li>
<li>Se você não for nerd, vai ficar no escuro por enquanto, mas o próximo passo vai te ajudar :)</li>
</ul>

<h2>Passo 4 - Mostrar na tela</h2>

<p>Aqui é um ponto onde cada um pode seguir um caminho diferente.</p>

<ul>
<li><p><strong>Dados privados:</strong> Se você criou campos adicionais no formulário para coletar informações pessoais sobre seus leitores, não vai querer divulgá-las, então elas devem estar acessíveis somente para você, na interface de administração do WordPress.</p></li>
<li><p><strong>Dados públicos:</strong> Se os campos adicionais forem públicos, como por exemplo a conta do twitter do visitante, é legal mostrar junto com o próprio comentário.</p></li>
</ul>

<p>Pública ou privada, o método para obter a informação é o mesmo: basta usar a função <code>get_comment_meta()</code>, passando o ID do comentário e o nome do campo que você quer saber o conteúdo. Em nosso exemplo, este é o código para obter o nome da cidade e a sigla do estado e guardá-los em variáveis:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$cidade</span> <span class="o">=</span> <span class="nf">get_comment_meta</span><span class="p">(</span><span class="nf">get_comment_ID</span><span class="p">(),</span> <span class="s1">'cidade'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nv">$estado</span> <span class="o">=</span> <span class="nf">get_comment_meta</span><span class="p">(</span><span class="nf">get_comment_ID</span><span class="p">(),</span> <span class="s1">'estado'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="cp">?&gt;</span>
</code></pre></div>
<blockquote>
<p>Nota: Sem aquele <code>true</code> no final, o valor seria retornado dentro de um array, o que neste caso, não ajudaria em nada.</p>
</blockquote>

<p>E pronto, agora que está numa variável, é você quem decide onde quer mostrá-la. Basta editar o template de seu tema, mais especificamente o comments.php.</p>

<p>Beleza? É isso então.</p>

<p>Falou!</p>

<p>Tchau!</p>

<p>...</p>

<p>Ué, tá aqui ainda?</p>

<p>Tá bom, tá bom, eu mostro um código pronto :)</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">// functions.php</span>
<span class="c1">// Mostra a cidade e o estado (no backend) na lista de comentários</span>
<span class="c1">// O filtro comment_text serve para alterar o texto do comentário</span>

<span class="k">if</span> <span class="p">(</span><span class="nf">is_admin</span><span class="p">())</span> <span class="p">{</span>

    <span class="nf">add_filter</span><span class="p">(</span><span class="s1">'comment_text'</span><span class="p">,</span> <span class="s1">'mostra_campos'</span><span class="p">);</span>

    <span class="k">function</span> <span class="n">mostra_campos</span><span class="p">(</span><span class="nv">$texto_comentario</span><span class="p">)</span> <span class="p">{</span>

        <span class="nv">$cidade</span> <span class="o">=</span> <span class="nf">get_comment_meta</span><span class="p">(</span><span class="nf">get_comment_ID</span><span class="p">(),</span> <span class="s1">'cidade'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nv">$estado</span> <span class="o">=</span> <span class="nf">get_comment_meta</span><span class="p">(</span><span class="nf">get_comment_ID</span><span class="p">(),</span> <span class="s1">'estado'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$cidade</span> <span class="o">||</span> <span class="nv">$estado</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s2">"Cidade: </span><span class="nv">$cidade</span><span class="s2"> - </span><span class="nv">$estado</span><span class="se">\n\n</span><span class="nv">$texto_comentario</span><span class="s2">"</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$texto_comentario</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div>
<p><strong>Atualização:</strong> Veja neste outro artigo <a href="/wordpress/ios-comentarios-meta/">como mostrar os campos adicionais no app do WordPress para iPhone/iPad</a>.</p>

<h2>Detalhe</h2>

<ul>
<li>Esse esquema só funciona à partir do WordPress versão 3.0.</li>
</ul>

<h2>Referência</h2>

<ul>
<li><a href="http://codex.wordpress.org/Theme_Development#Functions_File">http://codex.wordpress.org/Theme_Development#Functions_File</a></li>
<li><a href="http://codex.wordpress.org/Function_Reference/comment_form">http://codex.wordpress.org/Function_Reference/comment_form</a></li>
<li><a href="http://codex.wordpress.org/Function_Reference/add_action">http://codex.wordpress.org/Function_Reference/add_action</a></li>
<li><a href="http://codex.wordpress.org/Function_Reference/add_filter">http://codex.wordpress.org/Function_Reference/add_filter</a></li>
<li><a href="http://codex.wordpress.org/Function_Reference/wp_die">http://codex.wordpress.org/Function_Reference/wp_die</a></li>
<li><a href="http://codex.wordpress.org/Plugin_API">http://codex.wordpress.org/Plugin_API</a></li>
</ul>

		</div><!--article-body-->

		<div id="article-footer">
			<div id="eof">— EOF —</div>

		</div>

	</div>
</div><!--#content-->




<div id="content-action" class="bar">
	<div class="wrapper">


	
		<p class="read-more">
			<span class="unicode-char heart">♥</span>
			Gostou desse texto?
			<a href="..">Aqui tem mais</a>.
		</p>

		<p class="subscribe">
			Assine o blog via
			<a href="/feed/">RSS</a> ou
			<a href="https://feedburner.google.com/fb/a/mailverify?uri=AurelioJargas&amp;loc=pt_BR">receba os textos por e-mail</a>.
		</p>



		<!-- http://www.sharelinkgenerator.com/ -->
		<p class="share">
			#compartilhe:
			<a target="_blank" rel="nofollow" href="https://twitter.com/home?status=WordPress:%20Como%20adicionar%20campos%20no%20formul%C3%A1rio%20de%20coment%C3%A1rios%20https://aurelio.net/wordpress/adicionar-campos-formulario-comentarios/">Twitter</a>,
			<a target="_blank" rel="nofollow" href="https://www.facebook.com/sharer/sharer.php?u=https://aurelio.net/wordpress/adicionar-campos-formulario-comentarios/">Facebook</a>,
			<a target="_blank" rel="nofollow" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://aurelio.net/wordpress/adicionar-campos-formulario-comentarios/">LinkedIn</a>
		</p>




	</div>
</div><!--#content-action-->









<div id="ad-bottom" class="bar">
	<div class="wrapper">
		
	<div class="ad-blog-box-bottom">

		<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
		<!-- Blog 336x280 -->
		<ins class="adsbygoogle"
		     style="display:inline-block;width:336px;height:280px"
		     data-ad-client="ca-pub-0009608813278754"
		     data-ad-slot="1899275611"></ins>
		<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
		</script>

	</div>


	</div>
</div>




<div id="sidebar" class="bar">
	<div class="wrapper">
			<div id="bio" class="sidebar-box">
		<p>
			<img src="/img/avatar-alpha.png">
			Oi! Sou o
			Aur<a href="/blog/2011/05/26/aos-33-descobri-que-meu-nome-nao-tem-acento/">e</a>lio Jargas,
			44,
			pai, nerd e
			<a href="/blog/2009/09/24/escritor/">escritor</a>.
			Moro em Ulm (Alemanha) com minha amada esposa <a href="/tags/#mog">Mog</a> e meus filhos Marcelo e Melissa.
		</p>
	</div>

	<div id="meus-livros" class="sidebar-box">
		<h4>Meus livros</h4>
		<p>
			<a href="https://www.piazinho.com.br">Expressões Regulares</a><br>
			<a href="https://www.shellscript.com.br">Shell Script Profissional</a>
		</p>
	</div>

	<div id="softwares" class="sidebar-box">
		<h4>Meus softwares</h4>
		<p>
			<a href="/projects/adiumbook/">AdiumBook</a>,
			<a href="/coisinha/caraoucoroa/">Cara ou Coroa?</a>,
			<a href="/projects/css-sandbox/">CSS Sandbox</a>,
			<a href="https://github.com/aureliojargas/clitest">clitest</a>,
			<a href="/coisinha/embriagueitor/">Embriagueitor</a>,
			<a href="/projects/emomemory/">EmoMemory</a>,
			<a href="/coisinha/engripeitor/">Engripeitor</a>,
			<a href="https://funcoeszz.net">Funções ZZ</a>,
			<a href="/coisinha/miguxeitor/">MiGuXeiToR</a>,
			<a href="/moneylog/">MoneyLog</a>,
			<a href="/rac/">RAC</a>,
			<a href="/coisinha/relogio/">Relógio textual</a>,
			<a href="/projects/sedarkanoid/">SedArkanoid</a>,
			<a href="/projects/sedsokoban/">SedSokoban</a>,
			<a href="/projects/sedsed/">sedsed</a>,
			<a href="/coisinha/subwaytor/">Subwaytor</a>,
			<a href="/coisinha/tabuada/">Tabuada</a>,
			<a href="/util/text-tool.html">Simple Text Tool</a>,
			<a href="/projects/txt2regex/">txt2regex</a>,
			<a href="http://txt2tags.org">txt2tags</a>,
			<a href="http://umportugues.com">Um Português</a>,
			<a href="/coisinha/viravira/">vira|ɐɹıʌ</a>
		</p>
	</div>

	<div id="blog" class="sidebar-box">
		<h4>Blog</h4>
		<p>
			<a href="/blog/sumario/">sumário</a>,
			<a href="/tags/">tags</a>,
			<a href="/blog/">posts recentes</a>
		</p>
	</div>

	<div id="nerd" class="sidebar-box">
		<h4>Nerdices</h4>
		<p>
			<a href="/applescript/">applescript</a>
			<a href="/bin/">bin</a>
			<a href="/shell/canivete/">canivete</a>
			<a href="https://codare.aurelio.net">codare</a>
			<a href="/coisinha/">coisinha</a>
			<a href="/cygwin/">cygwin</a>
			<a href="/shell/dialog/">dialog</a>
			<a href="/doc/">doc</a>
			<a href="/curso/">eventos</a>
			<a href="/doc/coluna/">linux</a>
			<a href="/livro/">livro</a>
			<a href="/mac/">mac</a>
			<a href="/shell/miniman/">miniman</a>
			<a href="/mac/dev/tutorial-pyobjc/">pyobjc</a>
			<a href="/regex/">regex</a>
			<a href="/tags/#screencast">screencast</a>
			<a href="/sed/">sed</a>
			<a href="/shell/">shell</a>
			<a href="/vim/">vim</a>
			<a href="/unicode.txt">unicode</a>
			<a href="/wordpress/">wordpress</a>
		</p>
	</div>

	<div id="outros" class="sidebar-box">
		<h4>Outros</h4>
		<p>
			<a href="/viagem/atacama/">atacama</a>
			<a href="/musica/#minhas-bandas">bandas</a>
			<a href="/baterna/">baterna</a>
			<a href="/carve/">carveboard</a>
			<a href="/fvm/">faça-você-mesmo</a>
			<a href="/musica/">música</a>
			<a href="/foto/pe/">pé</a>
			<a href="/pogo/">pogo</a>
			<a href="/surf/">surf</a>
			<a href="/viagem/">viagem</a>
		</p>
	</div>

	<div id="jaba" class="sidebar-box">
		<h4>Jabá</h4>
		<ul>
			<li title="Use este link e o código OREIO30 para ganhar 30 dólares de desconto ao assinar o plano de hospedagem do DreamHost.">
				<a href="http://www.dreamhost.com/r.cgi?251258">DreamHost:</a>
				-$30 com OREIO30
			</li>
			<li title="Clique neste link antes de assinar o pacote de temas do ElegantThemes. Ganharei 50% do valor que você pagar.">
				<a href="http://www.elegantthemes.com/affiliates/idevaffiliate.php?id=5032">ElegantThemes:</a>
				ganho 50%
			</li>
			<li title="Você usa muito a Wikipédia? Eu também! Faça sua parte, doando $$ para eles continuarem firmes online.">
				<a href="https://donate.wikimedia.org">Doe $$ pra Wikipédia!</a>
			</li>
		</ul>
	</div>

	<div id="top-15" class="sidebar-box">
		<h4>Top 15</h4>
		<ul>
			<li><a href="/blog/2007/05/27/choque-de-realidade/">Choque de realidade</a></li>
			<li><a href="/blog/2007/10/04/ida-ao-banco-em-matinhos/">Ida ao banco em Matinhos</a></li>
			<li><a href="/blog/2008/06/27/bingo/">BINGO!</a></li>
			<li><a href="/blog/2007/03/29/vamos-falar-de-grana/">Vamos falar de grana $$$</a></li>
			<li><a href="/blog/2007/10/07/fiz-trinta/">Fiz trinta</a></li>
			<li><a href="/blog/2008/04/22/a-mog-foi-no-fisl/">A Mog foi no FISL</a></li>
			<li><a href="/blog/2008/09/03/faire/">Fáire! Meu Fiat Uno pegou fogo</a></li>
			<li><a href="/blog/2005/11/30/processo-de-desnerdizacao/">Processo de desnerdização</a></li>
			<li><a href="/blog/2006/05/15/e-book-ou-livro-impresso-como-publicar-sua-obra/">E-book ou livro impresso?</a></li>
			<li><a href="/blog/2009/03/11/garoto-de-programa/">Garoto de programa</a></li>
			<li><a href="/blog/2009/09/24/escritor/">Escritor</a></li>
			<li><a href="/blog/2009/12/11/game-over-quase/">Game Over? Quase!</a></li>
			<li><a href="/blog/2010/09/23/estou-ha-5-anos-desempregado-viva/">Estou há 5 anos desempregado! Viva!</a></li>
			<li><a href="/blog/2011/04/19/o-jeito-shell-script-de-resolver-problemas/">O jeito Shell Script de resolver problemas</a></li>
			<li><a href="/blog/2011/05/26/aos-33-descobri-que-meu-nome-nao-tem-acento/">Aos 33, descobri que meu nome não tem acento!</a></li>
			<li><a href="/blog/2012/08/25/rotina-de-escritor/">Rotina de escritor</a></li>
		</ul>
	</div>

	<div class="sidebar-box">
		<h4>Minha carreira</h4>
		<ul>
			<li>1997 – Entrei na Conectiva</li>
			<li><a href="/blog/2005/09/23/free-as-in-bird/">2005 – Saí da Conectiva</a></li>
			<li><a href="/blog/2005/11/30/processo-de-desnerdizacao/">2005 – Processo de desnerdização</a></li>
			<li><a href="/blog/2006/02/08/de-nerd-a-fotografo/">2006 – Fotógrafo de surfe</a></li>
			<li><a href="/blog/2007/03/29/vamos-falar-de-grana/">2007 – Como ganho dinheiro</a></li>
			<li><a href="/blog/2009/09/24/escritor/">2009 – Escritor</a></li>
			<li><a href="/blog/2010/09/23/estou-ha-5-anos-desempregado-viva/">2010 – Desempregado há 5 anos</a></li>
			<li><a href="/blog/2014/11/08/funcionario-publico/">2013 – Funcionário público</a></li>
			<li><a href="/blog/2017/02/06/contaazul/">2016 – ContaAzul</a></li>
			<li><a href="https://twitter.com/oreio/status/1017739410534748160">2018 – BMW, Alemanha</a></li>
		</ul>
	</div>

	<div id="recentes" class="sidebar-box">
		<h4>Textos Recentes</h4>
		<ul>

			<li><a href="/blog/2017/02/06/contaazul/">Minha experiência na ContaAzul</a></li>

			<li><a href="/blog/2016/11/09/serei-papai/">Serei papai \o/</a></li>

			<li><a href="/blog/2016/08/09/tela-preta-9/">Tela Preta episódio 9: Contar palavras com egrep|sort|uniq</a></li>

			<li><a href="/curso/fisl-17/">Palestra “Shell Script Moderno” no FISL17</a></li>

			<li><a href="/blog/2016/06/18/ensaio-banda/">Raridade: teve ensaio da banda</a></li>

			<li><a href="/curso/sc-dev-summit/">Palestra “O poder da linha de comando” no SC Dev Summit 2016</a></li>

			<li><a href="/blog/2016/04/02/tres-empregos/">Tenho três empregos</a></li>

			<li><a href="/blog/2016/03/02/aprender-regex/">Aprenda expressões regulares em um dia</a></li>

			<li><a href="/blog/2016/02/09/sed-salva/">Sed salva o dia novamente</a></li>

			<li><a href="/blog/2015/10/03/poscomp/">Fiz a prova POSCOMP</a></li>

			<li><a href="/blog/2015/09/18/eu-no-podcast-castalio/">Eu no podcast Castálio</a></li>

			<li><a href="/blog/sumario/">→ Veja mais…</a></li>
		</ul>
	</div>

	</div>
</div><!--#sidebar-->




<div id="comments" class="bar">
	<div class="wrapper">
		
	<!-- Disqus comments -->

	<div id="disqus_thread"></div>
	<script>
	    (function() {
	        var d = document, s = d.createElement('script');
	        s.src = 'https://aurelionet.disqus.com/embed.js';
	        s.setAttribute('data-timestamp', +new Date());
	        (d.head || d.body).appendChild(s);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

	<!-- /Disqus comments -->


	</div>
</div><!--#comments-->




<div id="footer" class="bar">
	<div class="wrapper">
		<a href="/">Aurelio.net</a> é o site pessoal de
		<a href="/aurelio/">Aurelio Jargas</a>.
		<br>
		<a href="/blog/2009/06/27/10-anos-de-saite/">Desde 1999 no ar</a>,
		feito com <span class="unicode-char heart">♥</span>,
		<a href="http://txt2tags.org">txt2tags</a>,
		<a href="http://jekyllrb.com/">Jekyll</a> e
		<a href="https://www.netlify.com/">Netlify</a>.
		<br>
		Conteúdo livre:
		<a href="http://creativecommons.org/licenses/by-nc/3.0/deed.pt_BR">CC BY-NC 3.0</a>
	</div>
</div><!--#footer-->

</body>
</html>
