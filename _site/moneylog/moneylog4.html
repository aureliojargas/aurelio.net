<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<!--


	****************************************************************
	***                                                          ***
	***   DO NOT EDIT THIS FILE IN MS WORD, use Notepad          ***
	***   More info at http://aurelio.net/projects/moneylog          ***
	***                                                          ***
	***   NÃO EDITE ESTE ARQUIVO NO WORD, use o Bloco de Notas   ***
	***   Mais informações em http://aurelio.net/moneylog        ***
	***                                                          ***
	****************************************************************

MoneyLog Experience
===================

	MoneyLog Experience is a one-file finances reporter.

	O MoneyLog Experience é um gerador de extratos em um único arquivo.

Author/Autor:
 	Aurelio Jargas (www.aurelio.net)

History/Histórico:
 	v1: Jun-Jul 2006
 	v2: Jan-Feb 2007 (english version on May/2007)
 	v3: Oct-Dec 2007
	v4: Ago 2009

License/Licença:
	MIT - http://en.wikipedia.org/wiki/MIT_license

-->

<head><title>$$$</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="generator" content="TextMate">
<meta name="author" content="Aurelio Marinho Jargas www.aurelio.net">
<meta name="keywords" content="Personal Finance, KISS, Simple, HTML, CSS, Javascript">
<meta name="description" content="MoneyLog Experience - Personal finances management made real simple. In one single editable text file you have all your transactions and the engine to query it. Alter with any text editor and view the reports on the browser. Made with HTML, CSS and JavaScript.">

<!--
All the page formatting is here.
You may change the styles if you know what you're doing.
-->
<style type="text/css">
/*
	moneylog.css
	http://aurelio.net/moneylog
*/

/* ---------------------------------------------- Reset CSS (from YUI) */

body,div,dl,dt,dd,ul,ol,li,h1,h2,h3,h4,h5,h6,pre,form,fieldset,input,textarea,p,blockquote,th,td { margin:0;padding:0; }
table { border-collapse:collapse;border-spacing:0; }
body { font:12px/1.231 arial,helvetica,clean,sans-serif;*font-size:small;*font:x-small; }
select,input,button,textarea { font:99% arial,helvetica,clean,sans-serif; }
table { font-size:inherit;font:100%; }
th,td { border-style:none;padding:.5em; }
p,blockquote,ul,ol,dl { margin:1em; }
ol,ul,dl { margin-left:2em; }
dl dd { margin-left:1em; }


/* ---------------------------------------------- Global settings */

body {
	color:#555;            /* fg1 */
	background-color:#fff; /* bg1 */
}
a {
	text-decoration:none;
	font-weight:bold;
}
input {
	margin-right:0.25em;
}
.trigger {
	cursor:pointer;
}
.posbar {
	background-color:#4D89F9 !important; /* bar1 */
}
.negbar {
	background-color:#f66 !important;   /* bar2 */
}
#tagsArea input,
#toolbar input,
#toolbar select,
#toolbar a,
#toolbar span {
	vertical-align:middle;
}

/* ---------------------------------------------- Toolbar */

#toolbar {
	color:#ddd;            /* fg2 */
	background-color:#444; /* bg2 */
	text-align:center;
	z-index:1;
	position:fixed;
	top:0;
	left:0;
	width:100%;
	height:8em;            /* y1 */
}
#toolbar a {
	color:#f44;            /* fg2a */
	font-size:185%;
	padding:0 4px;
}
#toolbar a:hover {
	background-color:#f44; /* fg2a */
	color:#444;            /* bg2 */
}
#toolbar .left {
	padding-left:2em;
	padding-right:2em;
}
#toolbar .middle {
	padding-left:0;
}
#toolbar #report-nav {
	margin:1em 0;
}
#toolbar #report-nav a {
	font-size:110%;
	border:1px solid #444; /* bg2 */
}
#toolbar #report-nav a:hover {
	background-color:#444; /* bg2 */
	color:#f44;            /* fg2a */
	border:1px dotted #f44; /* fg2a */
}
#toolbar #report-nav a.active {
	border:1px solid #f44; /* fg2a */
	outline-style:none; /* Firefox, Camino */
}
#toolbar a.helplink {
	float:right;
}
#toolbar #filterbox {
	float:right;
	text-align:left;
}
#toolbar #datafilesbox {
	clear:right;
	float:right;
	text-align:right; /* IE7 fix */
	padding:20px 0 0 0;
}
#toolbar #checkboxes {
	text-align:left;
	vertical-align:middle;
	line-height:185%; /* to fit selects */
}

/* ---------------------------------------------- Content */

#content {
	z-index:0;
	margin-top:8em;        /* y1 */
}

/* ---------------------------------------------- Tags */

#tagsArea {
	display:none;
	position:fixed;
	bottom:0;
	left:0;
	width:100%;
	padding:0.5em 0; /* see #operabug */
	line-height:150%;

	/* Same colors of #toolbar */
	color:#ddd;            /* fg2 */
	background-color:#444; /* bg2 */
}
#tagsArea #operabug {
	/* Wrapper needed by Opera9. Can't pad #tagsArea at left/right */
	padding:0 0.5em 0 1em;
}
#tagsArea #tagsLabel {
	font-weight:bold;
	color:#f44;            /* fg2a */
}
#tagsArea input+span {
	padding:1px 2px;
}
#tagsArea input[checked]+span { /* highlight selected tags */
	background:#f44;       /* fg2a */
	color:#000;            /* fg4 */
	border:1px solid #000; /* fg4 */
	padding:1px 1px;
}
#tagsArea input {
	display:none; /* hidden, but still used by JavaScript (exception: IE7 - see CC) */
	margin:0;
	padding:0;
}
#tagsArea #tagMultiAll {
	margin-top:-0.5em;
}
#tagsArea #tagMultiAll input {
	display:inline;
	margin-right:0.25em;
}
#tagsArea #tagList {
	display:inline;
}

/* ---------------------------------------------- Help */

#help {
	display:none;
	background-color:#faa; /* bg3 */
	color:#800;            /* fg3 */
	padding:2em;
	line-height:120%;
	
	/* IE7 bug: gap between #toolbar and #help if no border */
	border-top:1px solid #faa; /* bg3 */
}
#help a {
	text-decoration:underline;
}
#help ul ul {
	margin-top:0;
}

/* ---------------------------------------------- Data */

#data,
#dataFrame {
	display:none;
}

/* ---------------------------------------------- Report */

#report {
	padding:3em 3em 8em 2em;
	line-height:100%;
}
#report table {
	margin:0 auto;
}
#report th {
	text-align:center;
	cursor:pointer;
}
#report th:hover {
	color:#000;            /* fg4 */
	background-color:#ddd; /* bg4 */
}
#report td {
	border:1px solid #ddd; /* bd1 */
	padding:3px 10px;
	vertical-align:middle;
}
#report td.row-count {
	text-align:center;
	font-size:75%;
	color:#aaa;            /* fg5 */
	border-style:none;
	background-color:#fff; /* bg1 */
}
#report td.date {
	white-space:nowrap;
}
#report tr.future td.row-count {
	font-style:normal;
}
#report tr:hover td {
	background-color:#ddd; /* bg4 */
	color:#000;            /* fg4 */
}
#report tr:hover .neg {
	color:#f00;
}
#report tr.future {
	background-color:#eee; /* bg6 */
	font-style:italic;
}
#report .number {
	text-align:right !important;
	white-space:nowrap;
}
#report .neg {
	color:#e33;            /* fg_red */
}
#report .hl {
	color:#000;            /* fg4 */
	background-color:#faa; /* bg3 */
}
#report p { /* labelNoData */
	text-align:center;
}

/* ---------------------------------------------- Report - Daily */

/* Column sorting is not working for Balance, so undo formatting */
#report table.daily th.balance {
	cursor:auto;
}
#report table.daily th.balance:hover {
	color:#555;            /* fg1 */
	background-color:#fff; /* bg1 */
}
#report table.daily tr.total {
	background-color:#fee; /* bg5 */
	text-align:right;
	font-weight:bold;
}
#report table.daily tr.total td {
	border-style:none;
}
#report table.daily tr.total table.posneg {
	float:right;
	font-size:90%;
	font-weight:normal;
}
#report table.daily tr.total table.posneg td {
	padding:0;
	white-space:nowrap;
}
#report table.daily tr.total td.monthtotal {
	text-align:left;
	padding-left:0;
}
#report table.daily tr.total td.monthtotal .arrow {
	margin-right:8px;
}

/* ---------------------------------------------- Report - Monthly/Yearly */

#report table.overview tr.total {
	background-color:#fee; /* bg5 */
	font-style:italic;	
}
#report td.rowlabel {
	font-weight:bold;
}

/* ---------------------------------------------- Minibars inside report table */

#report table td.minibar {
	border-style:none !important;
}
#report table div.minibar {
	float:left;
}
#report table td.minibar .label {
	float:left;
	font-size:75%;
	color:white !important;
}

/* ---------------------------------------------- Charts */

#charts {
	display:none;
	margin-top:-4em;
	padding-bottom:3em;
	text-align:center;
}
table.chart {
	border:1px solid #ddd; /* bd1 */
	margin:0 auto;
	padding:10px;
}
table.chart td.bar {
	text-align:center;
	vertical-align:bottom;
}
table.chart td.bar div.bar {
	width:35px;
	margin:0 auto;
}
table.chart td.bar .label {
	font-size:11px;
	color:#444;            /* fg7 */
	font-style:italic;
}
table.chart tr.label {
	text-align:center;
	font-size:10px;
	line-height:100%;
	color:#444;            /* fg7 */
}


/* Minimum compatibility for IE5.5, IE6 */
#content { _margin-top:0; }
</style>
<script type="text/javascript">
/*
	moneylog.js
	http://aurelio.net/moneylog
*/

/*********************************************************************
* User Config
* -----------
*
* There is no need to change *anything*, but if you have special
* needs, here is the place to customize this script.
*
*********************************************************************/
// Program interface
var lang = 'pt';                  // 'pt' or 'en' for Portuguese or English
var maxLastMonths = 12;           // Number of months on the last months combo
var initLastMonths = 3;           // Initial value for last months combo
var defaultLastMonths = false;    // Last months combo inits checked?
var defaultMonthPartials = true;  // Monthly checkbox inits checked?
var defaultFuture = false;        // Show future checkbox inits checked?
var defaultRegex = false;         // Search regex checkbox inits checked?
var defaultNegate = false;        // Search negate checkbox inits checked?
var defaultSearch = '';           // Search for this text on init
var showRowCount = true;          // Show the row numbers at left?
var monthlyRowCount = true;       // The row numbers are reset each month?
var highlightWords = '';          // The words you may want to highlight (ie: 'XXX TODO')
var highlightTags = '';           // The tags you may want to highlight (ie: 'work kids')
var reportType = 'd';             // Initial report type: d m y (daily, monthly, yearly)

// Charts
var showMiniBars = true;          // Show the percentage bars in monthly/yearly reports?
var showMiniBarsLabels = true;    // Show the labels inside the bars?
var miniBarWidth = 70;            // The percentage bar width, in pixels
var showCharts = true;            // Show the bar chart after the monthly/yearly report?
var showChartBarLabel = true;     // Show the labels above the bars?

// Program structure and files
var oneFile = true;              // Full app is at moneylog.html single file?
var dataFiles = ['moneylog.txt']; // The paths for the data files (requires oneFile=false)
// Note: The dataFile encoding is UTF-8. Change to ISO-8859-1 if accents got mangled.

// Data format
var dataFieldSeparator = '\t';
var dataRecordSeparator = /\r?\n/;  // \r\n Windows, \n Linux/Mac
var dataTagTerminator = '|';
var dataTagSeparator = ',';
var commentChar = '#';   // Must be at line start (column 1)
var dataPatterns = {
	date:
		// YYYY-MM-DD
		/^ *(\d{4}-\d\d-\d\d) *$/,
	amountNumber:
		// 7  +7  -7  7.00  7,00  1234567,89  1.234.567,89  1,234,567.89 1234567,89
		/^ *([+\-]? *(\d+|\d{1,3}([.,]\d{3})*)([.,]\d\d)?) *$/,
	amountCents:
		// .12  ,12
		/[.,](\d\d) *$/,
	amountRecurrent:
		// *N or /N where N>0
		/([*\/])([1-9][0-9]*) *$/
};

// Internationalisation (i18n) - Screen Labels and formatting
var i18nDatabase = {
	pt: {
		labelLastMonths: 'Somente Recentes:',
		labelMonthPartials: 'Mostrar Parciais Mensais',
		labelFuture: 'Mostrar Lançamentos Futuros',
		labelNoData: 'Nenhum lançamento.',
		labelsDetailed: ['Data', 'Valor', 'Tags', 'Descrição', 'Acumulado'],
		labelsOverview: ['Período', 'Ganhos', 'Gastos', 'Saldo', 'Acumulado'],
		labelTotal: 'Total',
		labelAverage: 'Média',
		labelMinimum: 'Mínimo',
		labelMaximum: 'Máximo',
		labelMonths: ['mês', 'meses'],
		labelRegex: 'regex',
		labelNegate: 'excluir',
		labelDaily: 'diário',
		labelMonthly: 'mensal',
		labelYearly: 'anual',
		labelHelp: 'Ajuda',
		labelReload: 'Recarregar',
		labelValueFilter: 'Somente Valores:',
		labelPositive: 'positivo',
		labelNegative: 'negativo',
		labelGreaterThan: 'maior que',
		labelLessThan: 'menor que',
		labelTagEmpty: 'VAZIO',
		labelTagGroup: 'Unir as tags escolhidas',
		errorInvalidData: 'Lançamento inválido na linha ',
		errorNoFieldSeparator: 'Separador não encontrado:',
		errorTooManySeparators: 'Há mais de 2 sepadarores',
		errorInvalidDate: 'Data inválida:',
		errorInvalidAmount: 'Valor inválido:',
		appUrl: 'http://aurelio.net/moneylog',
		appDescription: 'Uma página. Um programa.',
		centsSeparator: ',',
		thousandSeparator: '.'
	},
	en: {
		labelLastMonths: 'Recent Only:',
		labelMonthPartials: 'Show Monthly Partials',
		labelFuture: 'Show Future Data',
		labelNoData: 'No data.',
		labelsDetailed: ['Date', 'Amount', 'Tags', 'Description', 'Balance'],
		labelsOverview: ['Period', 'Incoming', 'Expense', 'Partial', 'Balance'],
		labelTotal: 'Total',
		labelAverage: 'Average',
		labelMinimum: 'Min',
		labelMaximum: 'Max',
		labelMonths: ['month', 'months'],
		labelRegex: 'regex',
		labelNegate: 'negate',
		labelDaily: 'daily',
		labelMonthly: 'monthly',
		labelYearly: 'yearly',
		labelHelp: 'Help',
		labelReload: 'Reload',
		labelValueFilter: 'Filter Values:',
		labelPositive: 'positive',
		labelNegative: 'negative',
		labelGreaterThan: 'greater than',
		labelLessThan: 'less than',
		labelTagEmpty: 'EMPTY',
		labelTagGroup: 'Group selected tags',
		errorInvalidData: 'Invalid data at line ',
		errorNoFieldSeparator: 'No separator found:',
		errorTooManySeparators: 'Too many separators',
		errorInvalidDate: 'Invalid date:',
		errorInvalidAmount: 'Invalid amount:',
		appUrl: 'http://aurelio.net/projects/moneylog',
		appDescription: 'A webpage. A software.',
		centsSeparator: '.',
		thousandSeparator: ','
	}
};
// End of user Config


// Global vars
var sortColIndex = 0;
var sortColRev = false;
var oldSortColIndex;
var oldSortColRev;
var oldValueFilterArgShow;
var currentDate;
var highlightRegex;
var i18n;
var rawData = '';
var parsedData = [];
var overviewData = [];

// init and iframe loading are concurrent events that needs to be completed at the initial page load.
// So we need this silly flags to track the execution of both events.
var iframeIsLoaded = false;
var initIsDone = false;


/////////////////////////////////////////////////////////////////////
//                              PROTOTYPES
/////////////////////////////////////////////////////////////////////

if (!Array.prototype.push) { // IE5...
	Array.prototype.push = function (item) {
		this[this.length] = item;
		return this.length;
	};
}

if (!Number.prototype.toFixed) { // IE5...
	Number.prototype.toFixed = function (n) { // precision hardcoded to 2
		var k = (Math.round(this * 100) / 100).toString();
		k += (k.indexOf('.') == -1) ? '.00' : '00';
		return k.substring(0, k.indexOf('.') + 3);
	};
}

String.prototype.strip = function () {
	return this.replace(/^\s+/, '').replace(/\s+$/, '');
};

String.prototype.unacccent = function () {
	if (!this.match(/[^a-z0-9 ]/)) { // no accented char
		return this;
	}
	return this.replace(
		/[àáâãäå]/g, 'a').replace(
		/[èéêë]/g, 'e').replace(
		/[ìíîï]/g, 'i').replace(
		/[òóôõö]/g, 'o').replace(
		/[ùúûü]/g, 'u').replace(
		/[ýÿ]/g, 'y').replace(
		/ç/g, 'c').replace(
		/ñ/g, 'n');
};

Array.prototype.hasItem = function (item) {
	for (var i = 0; i < this.length; i++) {
		if (item == this[i]) {
			return true;
		}
	}
	return false;
};

Array.prototype.removePattern = function (patt) {
	var i, cleaned = [];
	for (i = 0; i < this.length; i++) {
		if (this[i] != patt) {
			cleaned.push(this[i]);
		}
	}
	return cleaned;
};

RegExp.escape = function (str) {
	var specials = new RegExp('[.*+?|\\^$()\\[\\]{}\\\\]', 'g');
	return str.replace(specials, '\\$&');
};


/////////////////////////////////////////////////////////////////////
//                              TOOLS
/////////////////////////////////////////////////////////////////////

function invalidData(lineno, message) {
	alert(i18n.errorInvalidData + lineno + '\n' + message.replace(/\t/g, '<TAB>'));
}

function sortArray(a, b)  {
	a = a[sortColIndex];
	b = b[sortColIndex];
	try {
		if (sortColIndex == 2) {
			a = a.toLowerCase();
			b = b.toLowerCase();
		}
	} catch (e1) { }
	try { // IE6...
		if (a < b) {
			return -1;
		} else if (a > b) {
			return 1;
		}
	} catch (e2) { }
	return 0;
}

function sortIgnoreCase(a, b) {
	try {
		a = a.toLowerCase().unacccent();
		b = b.toLowerCase().unacccent();
	} catch (e1) { }
	try { // IE6...
		if (a < b) {
			return -1;
		} else if (a > b) {
			return 1;
		}
	} catch (e2) { }
	return 0;
}

function setCurrentDate() {
	var z, m, d;
	z = new Date();
	m = z.getMonth() + 1;
	d = z.getDate();
	m = (m < 10) ? '0' + m : m;
	d = (d < 10) ? '0' + d : d;
	currentDate = z.getFullYear() + '-' + m + '-' + d;
}

function getPastMonth(months) {
	var z, m, y;
	z = new Date();
	m = z.getMonth() + 1 - months; // zero based
	y = z.getFullYear();
	if (m < 1) { // past year
		m = 12 + m;
		y = y - 1;
	}
	m = (m < 10) ? '0' + m : m;
	return y + '-' + m + '-' + '00';
}

function addMonths(yyyymmdd, n) {
	var y, m, d;
	yyyymmdd = yyyymmdd.replace(/-/g, '');
	y = parseInt(yyyymmdd.slice(0, 4), 10);
	m = parseInt(yyyymmdd.slice(4, 6), 10);
	d = yyyymmdd.slice(6, 8);
	m = m + n;
	if (m > 12) {
		y = y + Math.floor(m / 12);
		m = m % 12;
		if (m === 0) { // Exception for n=24, n=36, ...
			m = 12;
			y = y - 1;
		}
	}
	m = (m < 10) ? '0' + m : m;
	return y + '-' + m + '-' + d;
}

function prettyFloat(num, noHtml) {
	var myClass = (num < 0) ? 'neg' : 'pos';
	num = num.toFixed(2).replace('.', i18n.centsSeparator);
	while (i18n.thousandSeparator && num.search(/[0-9]{4}/) > -1) {
		num = num.replace(/([0-9])([0-9]{3})([^0-9])/,
			'$1' + i18n.thousandSeparator + '$2$3');
	}
	return (noHtml) ? num : '<span class="' + myClass + '">' + num + '<\/span>';
	// Note: all html *end* tags have the / escaped to pass on validator
}

function prettyBarLabel(n) {
	var negative;
	negative = (n < 0);
	if (negative) {
		n = Math.abs(n);
	}
	if (n < 1000) {
		n = n.toString().replace(/\.(\d).*/, ''); // 123,45 > 123
	} else if (n >= 1000 && n < 1000000) {
		n = (n / 1000).toString().replace(/\.(\d).*/, 'k$1'); // 1.234,45 > 1k2
	} else if (n >= 1000000) {
		n = (n / 1000).toString().replace(/\.(\d).*/, 'm$1'); // 1.234.567,89 > 1m2
	}
	if (negative) {
		n = '-' + n;
	}
	return n.replace(/([km])0/, '$1'); // 2k0 > 2k
}

/////////////////////////////////////////////////////////////////////
//                         REPORT HELPERS
/////////////////////////////////////////////////////////////////////

function getMiniBar(pos, neg) {
	var roof, posPx, negPx, posLabel, negLabel, posMargin, negMargin, labels, labelTemplate;

	// The total amount for this period
	roof = pos + Math.abs(neg);
	// The size of each bar (pixels)
	posPx = parseInt(pos * miniBarWidth / roof, 10);
	negPx = miniBarWidth - posPx;
	// The percentage of each bar (%)
	posLabel = parseInt(pos * 100 / roof, 10);
	negLabel = 100 - posLabel;
	
	// Labels
	labels = '';
	if (showMiniBarsLabels) {
		labelTemplate = '<span class="label" style="margin-left:-{margin}">{label}<\/span>';

		// The label positioning (negative margin)
		posMargin = (miniBarWidth - 2) + 'px';                // full bar width
		negMargin = ((negLabel == 100) ? '2' : '1.4') + 'em'; // 1.4em or 2em

		// Hide label when it's zero
		if (posLabel > 0) {
			labels += labelTemplate.replace('{margin}', posMargin).replace('{label}', posLabel);
		}
		if (negLabel > 0) {
			labels += labelTemplate.replace('{margin}', negMargin).replace('{label}', negLabel);
		}
	}
	
	// Kinda complicated layout
	// DIVs and SPANs are float:left to be aligned in order, at the same line
	// SPANs (labels) are moved left (negative margin) precisely to "enter" the bars
	// The TD width *must* be set to accomodate these tricks
	//
	return '<td class="minibar" style="width:' + (miniBarWidth + 2) + 'px">' +
		'<div class="minibar posbar" style="width:' + posPx + 'px">&nbsp;<\/div>' +
		'<div class="minibar negbar" style="width:' + negPx + 'px">&nbsp;<\/div>' +
		labels +
		'<\/td>';
}

function getTotalsRow(total, monthTotal, monthNeg, monthPos) {
	var partial, theRow;
	
	partial = [];
	partial.push('<table class="posneg number"><tr>');
	partial.push('<td> +');
	partial.push(prettyFloat(monthPos, true) + '<br>');
	partial.push(prettyFloat(monthNeg, true));
	partial.push('<\/td><\/tr><\/table>');
	partial = partial.join('');

	// Show month total?
	if (monthTotal !== '') {
		monthTotal = '<span class="arrow">→<\/span>' + prettyFloat(monthTotal);
	}

	theRow = '<tr class="total">';
	if (showRowCount) {
		theRow += '<td class="row-count"><\/td>';
	}
	theRow += '<td><\/td>';
	theRow += '<td>' + partial + '<\/td>';
	theRow += '<td class="monthtotal" colspan="2">' + monthTotal + '<\/td>';
	theRow += '<td class="number">' + prettyFloat(total) + '<\/td>';
	theRow += '<\/tr>';
	return theRow;
}

function getOverviewRow(theMonth, monthPos, monthNeg, monthTotal, theTotal, rowCount) {
	var theRow = [];
	
	theRow.push((theMonth <= currentDate.slice(0, 7)) ? '<tr>' : '<tr class="future">');
	if (showRowCount) {
		theRow.push('<td class="row-count">' + rowCount + '<\/td>');
	}
	theRow.push('<td>' + theMonth + '<\/td>');
	theRow.push('<td class="number">' + prettyFloat(monthPos)  + '<\/td>');
	theRow.push('<td class="number">' + prettyFloat(monthNeg)  + '<\/td>');
	theRow.push('<td class="number">' + prettyFloat(monthTotal) + '<\/td>');
	theRow.push('<td class="number">' + prettyFloat(theTotal)  + '<\/td>');
	
	if (showMiniBars) {
		theRow.push(getMiniBar(monthPos, monthNeg));
	}
	
	theRow.push('<\/tr>');
	return theRow.join('\n');
}

function getOverviewTotalsRow(label, n1, n2, n3) {
	var theRow = [];
	theRow.push('<tr class="total">');
	if (showRowCount) {
		theRow.push('<td class="row-count"><\/td>');
	}
	theRow.push('<td class="rowlabel">' + label + '<\/td>');
	theRow.push('<td class="number">' + prettyFloat(n1) + '<\/td>');
	theRow.push('<td class="number">' + prettyFloat(n2) + '<\/td>');
	theRow.push('<td class="number">' + prettyFloat(n3) + '<\/td>');
	theRow.push('<td><\/td>');
	theRow.push('<\/tr>');
	return theRow.join('\n');
}


/////////////////////////////////////////////////////////////////////
//                        DATA HANDLERS
/////////////////////////////////////////////////////////////////////

function resetData() {
	overviewData = [];
	parsedData = [];
	rawData = '';
}

function loadDataFile(filePath) {
	resetData();
	iframeIsLoaded = false;
	document.getElementById("dataFrame").src = filePath;
	// This triggers the onLoad iframe event, handled by iframeLoaded()
}

function reloadData() {
	loadDataFile(document.getElementById('datafiles').value);
}

function readData() {
	var iframeDoc;
	
	// Read raw data from #data block (<PRE>) or from external dataFile (<IFRAME><PRE>)
	if (oneFile) {
		rawData = document.getElementById('data').innerHTML;
	} else {
		iframeDoc = document.getElementById('dataFrame').contentWindow.document;
		rawData = iframeDoc.getElementsByTagName('pre')[0].innerHTML;
	}
}

function parseData() {
	var i, j, rows, rowDate, rowAmount, rowText, rowTagsDescription, rowTags, rowDescription, recurrentAmount, recValue, recTimes, recOperator, lineno, fields, rowAmountErrorMsg, oldSort;

	// Reset the data holder
	parsedData = [];

	// Split lines
	rows = rawData.split(dataRecordSeparator);
	
	// Scan data rows
	for (i = 0; i < rows.length; i++) {
		lineno = i + 1;
		rowDate = rowAmount = rowText = '';

		///////////////////////////////////////////////////////////// Firewall

		// Skip commented rows
		if (rows[i].indexOf(commentChar) === 0) {
			continue;
		}
		// Skip blank lines
		if (!rows[i].strip()) {
			continue;
		}

		// Separate fields
		fields = rows[i].split(dataFieldSeparator);

		// Error: rows with no separator
		if (fields.length == 1) {
			invalidData(
				lineno,
				i18n.errorNoFieldSeparator + ' "' + dataFieldSeparator + '"\n\n' + rows[i]
			);
			return;

		// Error: too much separators
		} else if (fields.length - 1 > 2) {
			invalidData(
				lineno,
				i18n.errorTooManySeparators + ' "' + dataFieldSeparator + '"\n\n' + rows[i]
			);
			return;
		}

		///////////////////////////////////////////////////////////// Text

		rowText = (fields.length > 2) ? fields[2].strip() : '';

		///////////////////////////////////////////////////////////// Date
		
		rowDate = fields[0].match(dataPatterns.date);
		if (rowDate) {
			rowDate = rowDate[1]; // group 1
		} else {
			invalidData(lineno, i18n.errorInvalidDate + ' ' + fields[0] + '\n\n' + rows[i]);
		}

		///////////////////////////////////////////////////////////// Amount
		
		rowAmountErrorMsg = i18n.errorInvalidAmount + ' ' + fields[1] + '\n\n' + rows[i];

		// Extract (and remove) recurrent information from the amount (if any)
		recurrentAmount = fields[1].match(dataPatterns.amountRecurrent);
		if (recurrentAmount) {
			recTimes = parseInt(recurrentAmount[2], 10);
			recOperator = recurrentAmount[1];
			fields[1] = fields[1].replace(dataPatterns.amountRecurrent, '');
		}

		// Validade the amount value
		rowAmount = fields[1].match(dataPatterns.amountNumber);
		if (rowAmount) {
			rowAmount = rowAmount[1].replace(/\s+/g, ''); // group 1, no blanks

			// Normalize Value
			// Force '.' as internal cents separator, remove other punctuation
			// Ex.: 1.234,56 > 1.234@56 > 1234@56 > 1234.56
			rowAmount = rowAmount.replace(
				dataPatterns.amountCents, '@$1').replace(
				/[.,]/g, '').replace(
				'@', '.');

			// Now we can validate the number (str2float)
			rowAmount = parseFloat(rowAmount);
			
			// Ops, we don't have a valid number
			if (isNaN(rowAmount)) {
				invalidData(lineno, rowAmountErrorMsg);
				return;
			}
		} else {
			invalidData(lineno, rowAmountErrorMsg);
			return;
		}

		///////////////////////////////////////////////////////////// Recurrent Value

		// A value of -100/10 means I've spent 100 and will pay it in 10x
		// A value of -100*10 means I'll spent 100/month in the next 10 months
		// This idea came from myMoneyLog. Thanks Nishimura!
		//
		// Compose each payment row, changing: date, value and description
		// 2009-12-25  -90/3  Foo        |    2009-12-25  -90*3  Foo
		// turns to                      |    turns to
		// 2009-12-25  -30    Foo 1/3    |    2009-12-25  -90    Foo 1/3
		// 2010-01-25  -30    Foo 2/3    |    2010-01-25  -90    Foo 2/3
		// 2010-02-25  -30    Foo 3/3    |    2010-02-25  -90    Foo 3/3
		//
		// XXX It doesn't fix end-of-month day. Uses 2009-02-31 instead 2009-02-28. But it's OK.
		//
		// Note: the date/value filters must appear *after* the recurrent processing
		//
		if (recurrentAmount) {
			recValue = rowAmount;
			
			if (recOperator == '/') {
				recValue = (recValue / recTimes);
			}

			// Make sure we have a valid money value (not float)
			recValue = recValue.toFixed(2);
			
			// Compose and append each new row
			for (j = 1; j <= recTimes; j++) {
				rows.push([
					addMonths(rowDate, j - 1),
					recValue,
					rowText + ' ' + j + '/' + recTimes
				].join(dataFieldSeparator));
			}
			
			// Ignore the original recurring row
			continue;
		}
		
		///////////////////////////////////////////////////////////// Tags + Description

		// Parse tags
		if (rowText.indexOf(dataTagTerminator) != -1) {

			// Get tags
			// Note: tag terminator in description is allowed
			rowTagsDescription = rowText.split(dataTagTerminator);
			rowTags = rowTagsDescription.shift().split(dataTagSeparator);
			rowDescription = rowTagsDescription.join(dataTagTerminator).strip();
						
			// Strip all tags
			for (j = 0; j < rowTags.length; j++) {
				rowTags[j] = rowTags[j].strip();
			}
			// Remove empty tags
			rowTags = rowTags.removePattern('');
			
		// No tags
		} else {
			rowTags = [];
			rowDescription = rowText || '&nbsp;';
		}
		
		// Save the validated data
		parsedData.push([rowDate, rowAmount, rowTags, rowDescription]);
	}

	// Sort by date
	// Note: save/restore the global var contents
	oldSort = sortColIndex;
	sortColIndex = 0;
	parsedData.sort(sortArray);
	sortColIndex = oldSort;
}

function filterData() {
	var i, temp, isRegex, isNegated, filter, filterPassed, firstDate, showFuture, filteredData, thisDate, thisValue, thisTags, thisDescription, valueFilter, valueFilterArg;

	isRegex = false;
	isNegated = false;
	filter = '';
	firstDate = 0;
	filteredData = [];
		
	if (document.getElementById('optlastmonths').checked && reportType != 'y') {
		firstDate = getPastMonth(document.getElementById('lastmonths').value - 1);
	}
	
	// Show future works for both views
	showFuture = document.getElementById('optfuture').checked;
	
	// Get filters data for the detailed report
	if (reportType == 'd') {
		filter = document.getElementById('filter').value;
		isRegex = document.getElementById('optregex').checked;
		isNegated = document.getElementById('optnegate').checked;
		
		if (document.getElementById('optvaluefilter').checked) {
			valueFilter = document.getElementById('valuefilter').value;
			valueFilterArg = document.getElementById('valuefilterarg').value || 0;
		}
		
		// Hack: Value filtering on the search box!
		// Examples: v:+  v:-  v:=50  v:>100  v:<=-100
		temp = filter.match(/^v:([\-+>=<][=]?)([+\-]?\d*)$/);
		if (temp) {
			valueFilter = temp[1];
			valueFilterArg = temp[2] || 0;
			filter = ''; // The filter was (ab)used, now we can discard it
		}
	}
	
	// Prepare filter contents as /regex/ or string, always ignore case
	if (filter) {
		if (isRegex) {
			filter = new RegExp(filter.replace('/', '\\/'), 'i');
		} else {
			filter = filter.toLowerCase();
		}
	}

	// Scan data rows
	for (i = 0; i < parsedData.length; i++) {
		
		// date value [tags] description
		thisDate = parsedData[i][0];
		thisValue = parsedData[i][1];
		thisTags = parsedData[i][2];
		thisDescription = parsedData[i][3];
		
		///////////////////////////////////////////////////////////// Filters
		
		// Ignore dates older than "last N months" option (if checked)
		if (thisDate < firstDate) {
			continue;
		}

		// Ignore future dates
		if (!showFuture && thisDate > currentDate) {
			break;
		}

		// Apply value filter
		if (valueFilter) {
			if (valueFilter == '+' && thisValue < 0) { continue; }
			if (valueFilter == '-' && thisValue >= 0) { continue; }
			if (valueFilter == '>' && thisValue <= valueFilterArg) { continue; }
			if (valueFilter == '<' && thisValue >= valueFilterArg) { continue; }
			if (valueFilter == '=' && thisValue != valueFilterArg) { continue; }
			if (valueFilter == '>=' && thisValue < valueFilterArg) { continue; }
			if (valueFilter == '<=' && thisValue > valueFilterArg) { continue; }
		}

		// Search filter firewall - Will this line pass it?
		if (filter) {
			if (isRegex) {
				filterPassed = filter.test(parsedData[i].join('\t'));
			} else {
				filterPassed = (parsedData[i].join('\t').toLowerCase().indexOf(filter) != -1);
			}
			if ((!filterPassed && !isNegated) || (filterPassed && isNegated)) {
				continue;
			}
		}
		
		// Save the results
		filteredData.push([thisDate, thisValue, thisTags, thisDescription]);
	}
	
	return filteredData;
}

function applyTags(theData) {
	// This function composes the full tag menu and
	// also filters theData if some tag is selected
	
	var i, j, rowTags, thisTag, tagMatched, tagName, tagId, checked, tagCount, tagElement, tagsMenu, selectedTags, filteredData, tagMultiAll;
	
	tagsMenu = [];
	selectedTags = [];
	filteredData = [];
	
	// Get multiple selection mode (true=AND, false=OR)
	tagMultiAll = document.getElementById('tagMultiAllCheck').checked;
	
	// Get currently selected tags (from interface)
	try {
		tagCount = document.getElementById('tagCount').value;
		for (i = 1; i <= tagCount; i++) {
			tagElement = document.getElementById('tag_' + i);
			if (tagElement && tagElement.checked) {
				selectedTags.push(tagElement.value);
			}
		}
	} catch (e) { }
	
	// Filter data to match current tags
	for (i = 0; i < theData.length; i++) {
		
		// Array order: date, amount, tags, desc
		rowTags = theData[i][2];
		
		// Populate tags array with UNIQUE row tags
		for (j = 0; j < rowTags.length; j++) {
			if (!tagsMenu.hasItem(rowTags[j])) {
				tagsMenu.push(rowTags[j]);
			}
		}

		// Tag Filter is active. This line matches it?
		if (selectedTags.length > 0) {
		
			for (j = 0; j < selectedTags.length; j++) {

				thisTag = selectedTags[j];
				tagMatched = (rowTags.hasItem(thisTag) ||
					(thisTag == i18n.labelTagEmpty && rowTags.length === 0));
					// Tip: space means no tag
				
				if (tagMatched && (!tagMultiAll)) { break; } // OR
				if (!tagMatched && (tagMultiAll)) { break; } // AND
			}
			if (tagMatched) {
				filteredData.push(theData[i]);
			}
		}
	}
	
	// Make sure the menu has all the selected tags
	for (i = 0; i < selectedTags.length; i++) {
		if (!tagsMenu.hasItem(selectedTags[i]) && selectedTags[i] != i18n.labelTagEmpty) {
			tagsMenu.push(selectedTags[i]);
		}
	}

	// Compose the tags menu HTML code (if we have at least one tag)
	if (tagsMenu.length > 0) {
		
		// Sorted tags are nice
		tagsMenu.sort(sortIgnoreCase);

		// Add a last empty item to match the rows with no tag
		tagsMenu.push(i18n.labelTagEmpty);
		
		// Save the total tag count
		document.getElementById('tagCount').value = tagsMenu.length;
		
		// Add one checkbox for each tag
		for (i = 0; i < tagsMenu.length; i++) {
			tagName = tagsMenu[i];
			tagId = 'tag_' + (i + 1);
			
			// Selected tags remain selected
			checked = selectedTags.hasItem(tagName) ? 'checked="checked"' : '';
			
			// The ugly code (but better than DOM-walking nightmares)
			tagsMenu[i] = '<input type="checkbox" class="trigger" onClick="showReport()" ' +
				checked + ' id="' + tagId + '" value="' + tagName + '">' +
				'<span class="trigger" onClick="document.getElementById(\'' + tagId + '\').click()">' + tagName + '<\/span>';
		}

		// All tags in one single line
		tagsMenu = tagsMenu.join('\n');
	}
	
	// Save the tags menu (or make it empty)
	document.getElementById('tagList').innerHTML = tagsMenu;
	
	// Show the tags menu if we have at least one tag
	document.getElementById('tagsArea').style.display = (
		tagsMenu.length > 0) ? 'block' : 'none';

	// The '+' checkbox is only shown if we have multiple selected tags
	document.getElementById('tagMultiAll').style.display = (
		selectedTags.length > 1) ? 'block' : 'none';

	// Tag filter was active?
	if (selectedTags.length > 0) {
		return filteredData;
	} else {
		return theData;
	}
}


/////////////////////////////////////////////////////////////////////
//                          REPORTS
/////////////////////////////////////////////////////////////////////

function showOverview() {
	var i, z, len, rowDate, rowAmount, theData, thead, results, grandTotal, dateSize, rangeDate, rangeTotal, rangePos, rangeNeg, sumPos, sumNeg, sumTotal, currSortIndex, minPos, minNeg, minPartial, minBalance, maxPos, maxNeg, maxPartial, maxBalance, maxNumbers, minNumbers, chart, chartBars, chartLabels, chartCol, chartRoof, chartBarSize, chartBarLabel, chartBarClass;

	results = [];
	grandTotal = rangeTotal = rangePos = rangeNeg = sumPos = sumNeg = sumTotal = 0;
	minPos = minNeg = minPartial = minBalance = maxPos = maxNeg = maxPartial = maxBalance = 0;
	currSortIndex = sortColIndex;

	// Table headings
	thead = '<th onClick="sortCol(0, true)">' + i18n.labelsOverview[0] + '<\/th>';
	thead += '<th onClick="sortCol(1, true)">' + i18n.labelsOverview[1] + '<\/th>';
	thead += '<th onClick="sortCol(2, true)">' + i18n.labelsOverview[2] + '<\/th>';
	thead += '<th onClick="sortCol(3, true)">' + i18n.labelsOverview[3] + '<\/th>';
	thead += '<th onClick="sortCol(4, true)">' + i18n.labelsOverview[4] + '<\/th>';
	if (showMiniBars) {
		thead += '<th>%<\/th>';
	}
	if (showRowCount) {
		thead = '<th class="row-count"><\/th>' + thead;
	}

	if (!overviewData.length) { // Data not cached
		theData = filterData();
	}

	if (overviewData.length || theData.length) {
		results.push('<table class="overview">');
		results.push('<tr>' + thead + '<\/tr>');

		// The cache is empty. Scan and calculate everything.
		if (!overviewData.length) {
						
			for (i = 0; i < theData.length; i++) {
				rowDate        = theData[i][0];
				rowAmount      = theData[i][1];
				/* rowTags        = theData[i][2]; */
				/* rowDescription = theData[i][3]; */

				// rowDate.slice() size, to extract 2000 or 2000-01
				dateSize = (reportType == 'y') ? 4 : 7;
				
				// First row, just save the month/year date
				if (i === 0) {
					rangeDate = rowDate.slice(0, dateSize);
				}

				// Other rows, detect if this is a new month/year
				if (i > 0 &&
					rowDate.slice(0, dateSize) !=
					theData[i - 1][0].slice(0, dateSize)) {
					
					// Send old month/year totals to the report
					overviewData.push([rangeDate, rangePos, rangeNeg, rangeTotal, grandTotal]);
					// Reset totals
					rangeTotal = rangePos = rangeNeg = 0;
					// Save new month/year date
					rangeDate = rowDate.slice(0, dateSize);
				}
				
				// Common processing for all rows: update totals
				grandTotal += rowAmount;
				rangeTotal += rowAmount;
				if (rowAmount < 0) {
					rangeNeg += rowAmount;
				} else {
					rangePos += rowAmount;
				}
			}
			// No more rows. Send the last range totals to the report.
			overviewData.push([rangeDate, rangePos, rangeNeg, rangeTotal, grandTotal]);
		}
		// End of cache filling
		
		//// Report data is OK inside overviewData array
		//// Now we must compose the report table
		
		// Perform the user-selected sorting column and order
		sortColIndex = currSortIndex;
		overviewData.sort(sortArray);
		if (sortColRev) {
			overviewData.reverse();
		}
		
		// Array2Html
		for (i = 0; i < overviewData.length; i++) {
			
			// Calculate overall totals
			z = overviewData[i];
			sumPos   += z[1];
			sumNeg   += z[2];
			sumTotal += z[3];
			
			// Store min/max values
			if (i === 0) {
				// First value, store it as max and min
				minPos     = maxPos     = z[1];
				minNeg     = maxNeg     = z[2];
				minPartial = maxPartial = z[3];
				minBalance = maxBalance = z[4];
			} else {
				// Minimum
				minPos     = (z[1] < minPos)     ? z[1] : minPos;
				minNeg     = (z[2] < minNeg)     ? z[2] : minNeg;
				minPartial = (z[3] < minPartial) ? z[3] : minPartial;
				minBalance = (z[4] < minBalance) ? z[4] : minBalance;
				// Maximum
				maxPos     = (z[1] > maxPos)     ? z[1] : maxPos;
				maxNeg     = (z[2] > maxNeg)     ? z[2] : maxNeg;
				maxPartial = (z[3] > maxPartial) ? z[3] : maxPartial;
				maxBalance = (z[4] > maxBalance) ? z[4] : maxBalance;
			}
			
			// Save this row to the report table
			results.push(getOverviewRow(z[0], z[1], z[2], z[3], z[4], i + 1));
		}
		maxNumbers = [0, maxPos, maxNeg, maxPartial, maxBalance];
		minNumbers = [0, minPos, minNeg, minPartial, minBalance];
		
		// Compose the final rows: total, avg, min, max
		len = overviewData.length;
		results.push(getOverviewTotalsRow(i18n.labelTotal, sumPos, sumNeg, sumPos + sumNeg));
		results.push(getOverviewTotalsRow(i18n.labelAverage, sumPos / len, sumNeg / len, sumTotal / len));
		results.push(getOverviewTotalsRow(i18n.labelMinimum, minPos, maxNeg, minPartial));
		results.push(getOverviewTotalsRow(i18n.labelMaximum, maxPos, minNeg, maxPartial, maxBalance));
		// Note: Yes, maxNeg and minNeg are swapped for better reading
		
		// And we're done on the report table
		results.push('<\/table>');
		results = results.join('\n');
		
		// Now charts!
		if (showCharts) {
			chart = [];
			chartBars = [];
			chartLabels = [];
			chartCol = document.getElementById('chartcol').value || 1;
			
			// Get the maximum absolute value for this column
			chartRoof = (Math.abs(minNumbers[chartCol]) > maxNumbers[chartCol]) ?
				Math.abs(minNumbers[chartCol]) :
				maxNumbers[chartCol];
			
			// Calculate each bar size and format labels
			for (i = 0; i < overviewData.length; i++) {
				z = overviewData[i];
				chartBarSize = parseInt(Math.abs(z[chartCol]) * 100 / chartRoof, 10);
				chartBarLabel = prettyBarLabel(z[chartCol]);
				chartBars.push([chartBarLabel, chartBarSize]);
				chartLabels.push(z[0].replace('-', '<br>')); // date
			}
		
			// Compose the chart table
			chart.push('<table class="chart">');

			// First line is for the bars (label at top)
			chart.push('<tr>');
			for (i = 0; i < chartBars.length; i++) {
				chartBarClass = (chartBars[i][0].substring(0, 1) == '-') ? 'negbar' : 'posbar';
				chart.push('<td class="bar">');
				if (showChartBarLabel) {
					chart.push('<span class="label">' + chartBars[i][0] + '<\/span>');
				}
				chart.push('<div class="bar ' + chartBarClass + '" style="height:' + chartBars[i][1] + 'px"><\/div>');
				chart.push('</td>');
			}
			chart.push('<\/tr>');

			// Second line is for the labels
			chart.push('<tr class="label">');
			for (i = 0; i < chartLabels.length; i++) {
				chart.push('<td>' + chartLabels[i] + '<\/td>');
			}
			chart.push('<\/tr>');
			
			// And we're done
			chart.push('<\/table>');
			chart = chart.join('\n');
			
			document.getElementById('chart').innerHTML = chart;
		}
	} else {
		results = '<p>' + i18n.labelNoData + '</p>';
	}
	document.getElementById('report').innerHTML = results;
}

function showDetailed() {
	var thead, i, j, k, rowDate, rowAmount, rowTags, rowDescription, monthTotal, monthPos, monthNeg, rowCount, results, monthPartials, theData, sumPos, sumNeg, sumTotal;
	
	sumTotal = sumPos = sumNeg = monthTotal = monthPos = monthNeg = rowCount = 0;
	results = [];
	
	monthPartials = document.getElementById('optmonthly');
	theData = applyTags(filterData());
	
	if (theData.length > 0) {

		// Data sorting procedures
		if (sortColIndex !== 0 || sortColRev) {
			monthPartials.checked = false;
		}
		theData.sort(sortArray);
		if (sortColRev) {
			theData.reverse();
		}

		// Compose table headings
		thead = '<th onClick="sortCol(0)">' + i18n.labelsDetailed[0] + '<\/th>';
		thead += '<th onClick="sortCol(1)">' + i18n.labelsDetailed[1] + '<\/th>';
		thead += '<th onClick="sortCol(2)" class="tags">' + i18n.labelsDetailed[2] + '<\/th>';
		thead += '<th onClick="sortCol(3)">' + i18n.labelsDetailed[3] + '<\/th>';
		thead += '<th class="balance">' + i18n.labelsDetailed[4] + '<\/th>';
		if (showRowCount) {
			thead = '<th class="row-count"><\/th>' + thead;
		}
		results.push('<table class="daily">');
		results.push('<tr>' + thead + '<\/tr>');

		// Compose table rows
		for (i = 0; i < theData.length; i++) {
			
			rowDate        = theData[i][0];
			rowAmount      = theData[i][1];
			rowTags        = theData[i][2];
			rowDescription = theData[i][3];
			rowCount      += 1;
			
			// This row starts a new month? Must we show the partials?
			if (monthPartials.checked && i > 0 &&
				rowDate.slice(0, 7) !=
				theData[i - 1][0].slice(0, 7)) {
				results.push(getTotalsRow(sumTotal, monthTotal, monthNeg, monthPos));
				// Partials row shown, reset month totals
				monthTotal = 0;
				monthPos = 0;
				monthNeg = 0;
				if (monthlyRowCount) {
					rowCount = 1;
				}
			}
			
			// Update totals
			sumTotal += rowAmount;
			monthTotal += rowAmount;
			if (rowAmount < 0) {
				monthNeg += rowAmount;
				sumNeg += rowAmount;
			} else {
				monthPos += rowAmount;
				sumPos += rowAmount;
			}
			
			// There are some words to highlight on the Description?
			if (highlightRegex) {
				rowDescription = rowDescription.replace(
					highlightRegex,
					'<span class="hl">$&</span>');
			}
			
			// There are some tags to highlight?
			for (j = 0; j < highlightTags.length; j++) {
				for (k = 0; k < rowTags.length; k++) {
					if (rowTags[k] == highlightTags[j]) {
						rowTags[k] = '<span class="hl">' + rowTags[k] + '</span>';
						break;
					}
				}
			}
			
			// This row is in the future?
			if (rowDate <= currentDate) {
				results.push('<tr>');
			} else {
				results.push('<tr class="future">');
			}
			
			if (showRowCount) {
				results.push('<td class="row-count">' + (rowCount) + '<\/td>');
			}
			
			results.push('<td class="date">'   + rowDate                + '<\/td>');
			results.push('<td class="number">' + prettyFloat(rowAmount) + '<\/td>');
			results.push('<td class="tags">'   + rowTags.join(', ')     + '<\/td>');
			results.push('<td>'                + rowDescription         + '<\/td>');
			results.push('<td class="number">' + prettyFloat(sumTotal)  + '<\/td>');
			results.push('<\/tr>');
				
		}
		
		// Should we show the full month partials at the last row?
		if (monthPartials.checked) {
			results.push(getTotalsRow(sumTotal, monthTotal, monthNeg, monthPos));
		} else {
			results.push(getTotalsRow(sumTotal, '', sumNeg, sumPos));
		}
		
		results.push('<\/table>');
		results = results.join('\n');

		// Real dirty hack to insert totals row at the table beginning (UGLY!)
		// results = results.replace('<\/th><\/tr>', '<\/th><\/tr>' + getTotalsRow(sumTotal, '', sumNeg, sumPos));
	}
	else {
		results = '<p>' + i18n.labelNoData + '</p>';
	}
	document.getElementById('report').innerHTML = results;
}

function showReport() {
	if (reportType == 'd') {
		showDetailed();
	} else {
		showOverview();
	}
}

/////////////////////////////////////////////////////////////////////
//                       INTERFACE UPDATE
/////////////////////////////////////////////////////////////////////

function populateChartColsCombo() {
	var el, i;
	el = document.getElementById('chartcol');
	for (i = 0; i < i18n.labelsOverview.length; i++) {
		if (i === 0) {
			continue; // ignore date column
		}
		el.options[i - 1] = new Option(i18n.labelsOverview[i], i);
	}
}

function populateDataFilesCombo() {
	var el, i;
	if (!oneFile) {
		el = document.getElementById('datafiles');
		for (i = 0; i < dataFiles.length; i++) {
			el.options[i] = new Option(dataFiles[i]);
		}
	}
}

function populateMonthsCombo() {
	var el, label, i;
	el = document.getElementById('lastmonths');
	label = i18n.labelMonths[0];
	for (i = 1; i <= maxLastMonths; i++) {
		if (i > 1) {
			label = i18n.labelMonths[1];
		}
		el.options[i - 1] = new Option(i + ' ' + label, i);
	}
	el.selectedIndex = (initLastMonths > 0) ? initLastMonths - 1 : 0;
}

function populateValueFilterCombo() {
	var el;
	el = document.getElementById('valuefilter');
	el.options[0] = new Option('+ ' + i18n.labelPositive, '+');
	el.options[1] = new Option('- ' + i18n.labelNegative, '-');
	el.options[2] = new Option('> ' + i18n.labelGreaterThan, '>');
	el.options[3] = new Option('< ' + i18n.labelLessThan, '<');
}

function updateToolbar() {
	var i, add, remove, hide, unhide;

	// Visibility On/Off
	// Monthly/Yearly report hides some controls from the toolbar.
	//
	// Some fields are just hidden to preserve the page layout.
	// Others must be removed to free some space for the report.
		
	add = [];
	remove = [];
	hide = [];
	unhide = [];

	// Daily
	if (reportType == 'd') {
		add = ['tagsArea'];
		remove = ['charts'];
		unhide = [
			'filterbox',
			'optmonthly', 'optmonthlylabel',
			'optvaluefilter', 'optvaluefilterlabel', 'valuefilter',
			'optlastmonths', 'optlastmonthslabel', 'lastmonths'
		];
	// Monthly
	} else if (reportType == 'm') {
		add = ['charts'];
		remove = ['tagsArea'];
		hide = [
			'filterbox',
			'optmonthly', 'optmonthlylabel',
			'optvaluefilter', 'optvaluefilterlabel', 'valuefilter'
		];
		unhide = [
			'optlastmonths', 'optlastmonthslabel', 'lastmonths'
		];
	// Yearly
	} else if (reportType == 'y') {
		add = ['charts'];
		remove = ['tagsArea'];
		hide = [
			'filterbox',
			'optmonthly', 'optmonthlylabel',
			'optvaluefilter', 'optvaluefilterlabel', 'valuefilter',
			// Recent *months* doesn't make sense in yearly report
			'optlastmonths', 'optlastmonthslabel', 'lastmonths'
		];
	}
	
	// Show/hide toolbar elements
	for (i = 0; i < add.length; i++) {
		document.getElementById(add[i]).style.display = 'block';
	}
	for (i = 0; i < remove.length; i++) {
		document.getElementById(remove[i]).style.display = 'none';
	}
	for (i = 0; i < hide.length; i++) {
		document.getElementById(hide[i]).style.visibility = 'hidden';
	}
	for (i = 0; i < unhide.length; i++) {
		document.getElementById(unhide[i]).style.visibility = 'visible';
	}
}


/////////////////////////////////////////////////////////////////////
//                         EVENT HANDLERS
/////////////////////////////////////////////////////////////////////

function sortCol(index, isOverview) {
	// if the same, flip reverse state
	sortColRev = (sortColIndex == index) ? !sortColRev : false;
	sortColIndex = index;
	showReport();
}

function changeReport(el) {
	var oldType, newType;
	
	oldType = reportType;
	newType = el.id;
	
	// Deactivate old report, activate new
	document.getElementById(oldType).className = '';
	el.className = 'active';
	
	//// Save / restore information
	//
	// From Daily to Monthly/Yearly
	if (oldType == 'd' && newType != 'd') {
		oldValueFilterArgShow = document.getElementById('valuefilterarg').style.visibility;
		document.getElementById('valuefilterarg').style.visibility = 'hidden';
		oldSortColIndex = sortColIndex;
		oldSortColRev = sortColRev;
		sortColIndex = 0; // Default by date
		sortColRev = false;
	//
	// From Monthly/Yearly to Daily
	} else if (newType == 'd' && oldType != 'd') {
		document.getElementById('valuefilterarg').style.visibility = oldValueFilterArgShow;
		sortColIndex = oldSortColIndex || 0;
		sortColRev = oldSortColRev || false;
	}
	
	reportType = newType;
	overviewData = [];
	updateToolbar();
	showReport();
}

function iframeLoaded(el) {
	// Note: This function is attached to the iframe onLoad event.

	if (typeof el.loadCount == 'undefined') {
		el.loadCount = 0;
	}
	el.loadCount++;
	if (el.loadCount > 1) {
		// Discard the first iframe load, it's always blank, on the initial page load.
		// The other loads are for real.
		iframeIsLoaded = true;

		// Short explanation:
		// If the initial frame loading delayed, we read/parse the data right here.
		// Long explanation:
		// The frame loading is an event occuring in parallel with init().
		// Maybe the iframe contents is fully loaded before init() ends, maybe not.
		// The initIsDone flag tell us that init() is already done, so we must take action here.
		// If the loadCount > 2, it's a reload or new dataFile, so we also must parse the new data.
		//
		if ((el.loadCount == 2 && initIsDone) || el.loadCount > 2) {
			readData();
			parseData();
			showReport();
		}
	}
}

function lastMonthsChanged() {
	document.getElementById('optlastmonths').checked = true;
	overviewData = [];
	showReport();
}

function toggleFuture() {
	overviewData = [];
	showReport();
}

function toggleHelp() {
	var el = document.getElementById('help');
	el.style.display = (el.style.display == 'block') ? 'none' : 'block';
}

function toggleLastMonths() {
	overviewData = [];
	showReport();
}

function toggleMonthly() {
	if (document.getElementById('optmonthly').checked === true) {
		sortColIndex = 0;
		sortColRev = false;
	}
	showReport();
}

function valueFilterChanged() {
	overviewData = [];
	
	// autocheck checkbox
	document.getElementById('optvaluefilter').checked = true;
	
	// show/hide the filter argument textbox
	if (document.getElementById('valuefilter').value.match(/[+\-]/)) {
		document.getElementById('valuefilterarg').style.visibility = 'hidden';
	} else {
		document.getElementById('valuefilterarg').style.visibility = '';
	}
	
	showReport();
}


/////////////////////////////////////////////////////////////////////
//                             INIT
/////////////////////////////////////////////////////////////////////

function init() {
	
	// Load the i18n messages (must be the first)
	i18n = i18nDatabase[lang];

	setCurrentDate();
	populateMonthsCombo();
	populateDataFilesCombo();
	populateChartColsCombo();
	populateValueFilterCombo();
	
	// Sanitize and regexize user words: 'Foo Bar+' turns to 'Foo|Bar\+'
	// Note: Using regex to allow ignorecase and global *atomic* replace
	if (highlightWords) {
		highlightRegex = new RegExp(
			RegExp.escape(highlightWords).replace(/\s+/g, '|'),
			'ig');
	}
	
	// Split highlight string into words
	highlightTags = highlightTags.strip().split(/\s+/);
	
	// Just show the files combo when there are 2 or more files
	if (oneFile || dataFiles.length < 2) {
		document.getElementById('datafiles').style.display = 'none';
	}
	
	// Hide Reload button in oneFile mode. No iframe, so we can't reload.
	if (oneFile) {
		document.getElementById('reload').style.visibility = 'hidden';
	}
	
	// Set interface labels
	document.getElementById('optlastmonthslabel' ).innerHTML = i18n.labelLastMonths;
	document.getElementById('optmonthlylabel'    ).innerHTML = i18n.labelMonthPartials;
	document.getElementById('optfuturelabel'     ).innerHTML = i18n.labelFuture;
	document.getElementById('optregexlabel'      ).innerHTML = i18n.labelRegex;
	document.getElementById('optnegatelabel'     ).innerHTML = i18n.labelNegate;
	document.getElementById('optvaluefilterlabel').innerHTML = i18n.labelValueFilter;
	document.getElementById('tagMultiAllLabel'   ).innerHTML = i18n.labelTagGroup;
	document.getElementById('d'                  ).innerHTML = i18n.labelDaily;
	document.getElementById('m'                  ).innerHTML = i18n.labelMonthly;
	document.getElementById('y'                  ).innerHTML = i18n.labelYearly;
	document.getElementById('helpbutton').title = i18n.labelHelp;
	document.getElementById('reload'    ).title = i18n.labelReload;
	document.getElementById('sitelink'  ).title = i18n.appDescription;
	document.getElementById('sitelink'  ).href  = i18n.appUrl;

	// Hide all help content, then enable the current lang
	document.getElementById('help-en').style.display = 'none';
	document.getElementById('help-pt').style.display = 'none';
	document.getElementById('help-' + lang).style.display = '';

	// Mark current report as active (CSS)
	document.getElementById(reportType).className = 'active';
	
	// Apply user defaults
	if (defaultLastMonths)    { document.getElementById('optlastmonths').checked = true; }
	if (defaultMonthPartials) { document.getElementById('optmonthly'   ).checked = true; }
	if (defaultFuture)        { document.getElementById('optfuture'    ).checked = true; }
	if (defaultRegex)         { document.getElementById('optregex'     ).checked = true; }
	if (defaultNegate)        { document.getElementById('optnegate'    ).checked = true; }
	document.getElementById('filter').value = defaultSearch;

	// User choose other default report, let's update the toolbar accordingly
	if (reportType != 'd') {
		updateToolbar();
	}
	
	// We need to load the iframe contents first (if using external datafile)
	if (!oneFile) {
		loadDataFile(dataFiles[0]);
	}

	// Everything is ok, time to read/parse/show the user data
	if (oneFile || (!oneFile && iframeIsLoaded)) {
		readData();
		parseData();
		showReport();
	}
	
	// Uncomment this line to focus the search box at init
	// document.getElementById('filter').focus();

	initIsDone = true;
}
window.onload = init;
</script>

<!--[if lte IE 7]> 
    <style type="text/css">#tagsArea input { display:inline; }</style>
<![endif]-->
</head>

<body>

<!-- Toolbar -->
<table id="toolbar">
<tr>
<td class="left">
	<a id="sitelink" href="#">MoneyLog<br>Experience ::</a>
	
	<!-- Report Type -->
	<div id="report-nav">
		<a
			id="d" href="#" onClick="changeReport(this);return false"></a><a
			id="m" href="#" onClick="changeReport(this);return false"></a><a
			id="y" href="#" onClick="changeReport(this);return false"></a>
	</div>
	
</td>
<td class="middle">
	<div id="checkboxes">
		<!-- Last Months -->
		<input
			id="optlastmonths" class="trigger" type="checkbox"
			onClick="toggleLastMonths()"><span
			id="optlastmonthslabel" class="trigger"
			onClick="document.getElementById('optlastmonths').click()"></span>
		<select
		 	id="lastmonths" size="1" onChange="lastMonthsChanged()"></select>
		<br>

		<!-- Value Filter -->
		<input
		 	id="optvaluefilter" class="trigger" type="checkbox"
			onClick="showReport()"><span
			id="optvaluefilterlabel" class="trigger"
			onClick="document.getElementById('optvaluefilter').click()"></span>
		<select
		 	id="valuefilter" size="1" onChange="valueFilterChanged()">
		</select><input
			id="valuefilterarg" size="3" type="text" onKeyUp="showReport()"
			style="visibility:hidden">
		<br>

		<!-- Future -->
		<input
		 	id="optfuture" class="trigger" type="checkbox"
			onClick="toggleFuture()"><span
			id="optfuturelabel" class="trigger"
			onClick="document.getElementById('optfuture').click()"></span>
			<br>

		<!-- Monthly -->
		<input
		 	id="optmonthly" class="trigger" type="checkbox"
			onClick="toggleMonthly()"><span
			id="optmonthlylabel" class="trigger"
			onClick="document.getElementById('optmonthly').click()"></span>

	</div>
</td>
<td>
	<!-- Help -->
	<a id="helpbutton" class="helplink" href="#" onClick="toggleHelp();return false">?</a>

	<!-- Search -->
	<div id="filterbox">
		<!-- Note: Not using <form> to avoid action on Enter pressing -->
		<input id="filter" size="17" type="text" onKeyUp="showReport()">
		<br>
		<input
			id="optregex" class="trigger" type="checkbox"
			onClick="showReport()"><span
			id="optregexlabel" class="trigger"
			onClick="document.getElementById('optregex').click()"></span>
	
		<input
			id="optnegate" class="trigger" type="checkbox"
			onClick="showReport()"><span
			id="optnegatelabel" class="trigger"
			onClick="document.getElementById('optnegate').click()"></span>
	</div>

	<!-- Data Files -->
	<div id="datafilesbox">
		<select
		 	id="datafiles" size="1" onChange="loadDataFile(this.value)"></select>&nbsp;<a
			id="reload" href="#" onClick="reloadData();return false">®</a>
	</div>
</td>
</tr>
</table>

<div id="content">

	<div id="help">
	
	<div id="help-en">
	<p><strong>MoneyLog Experience</strong>:
	Track your finances the practical way. Think simple!
	<a href="http://aurelio.net/projects/moneylog/">Learn more...</a></p>
	<ul>
	<li><b>Reports:</b> Daily, monthly and yearly, with charts, balance and totals.</li>
	<br>
	<li><b>Recent Only:</b> See only the latest data, ignoring oldies.</li>
	<li><b>Filter Values:</b> See only positive or negative values, or greater/lesser than some value.</li>
	<li><b>Show Future Data:</b> Shows future incoming and expenses.</li>
	<li><b>Show Monthly Partials:</b> Shows the monthly balance, with sums of your incoming and expenses on the period.</li>
	<br>
	<li><b>Question mark:</b> Show/hide this help text.</li>
	<li>
		<b>Search field:</b> Filter the reports in real time, as you type.
		<ul>
		<li><b>regex:</b> Use regular expressions on the search field.</li>
		<li><b>negate:</b> Remove the search results from the report.</li>
		</ul>
	</li>
	<li><b>Tags:</b> Choose the desired tags for the report: food, health, education, trip, ...</li>
	</ul>
	<p><strong>Tip:</strong>
	On the reports, click the column header to sort the results. Click again for reverse sorting.</p>
	<p><strong>Instructions:</strong>
	Save this page, use a plain text editor to add your own transactions and open it on the browser.</p>
	</div>

	<div id="help-pt">
	<p><strong>MoneyLog Experience</strong>:
	Acompanhe suas finanças de maneira simples e prática. Descomplique!
	<a href="http://aurelio.net/moneylog">Saiba mais...</a></p>
	<ul>
	<li><b>Extratos:</b> Diário, mensal e anual, com gráficos, somatório, médias, mínimo, máximo e acumulado.</li>
	<br>
	<li><b>Somente Recentes:</b> Veja somente os dados mais recentes, ignorando os antigos.</li>
	<li><b>Somente Valores:</b> Veja somente valores positivos, negativos ou maiores/menores que um valor específico.</li>
	<li><b>Mostrar Lançamentos Futuros:</b> Veja quais lançamentos estão agendados para os meses seguintes.</li>
	<li><b>Mostrar Parciais Mensais:</b> Resumo do mês, com saldo mensal e acumulado, e totais de ganhos e gastos.</li>
	<br>
	<li><b>Interrogação:</b> Mostra e esconde este texto de ajuda.</li>
	<li>
		<b>Caixa de pesquisa:</b> Filtra os relatórios em tempo real, de acordo com o que você digita.
		<ul>
		<li><b>regex:</b> Usa <a href="http://aurelio.net/regex/">expressões regulares</a> na caixa de pesquisa.</li>
		<li><b>excluir:</b> Inverte o filtro, escondendo as transações pesquisadas.</li>
		</ul>
	</li>
	<li><b>Botão ®:</b> Recarrega somente os dados (só aparece quando se utiliza arquivo TXT externo).</li>
	<br>
	<li>
		<b>Tags:</b> Escolha que tipo de transações você quer ver: alimentação, saúde, educação, viagem, etc.
		<ul>
		<li><b>unir:</b> Mostra lançamentos que possuem todas as tags selecionadas (deve haver 2+ selecionadas).</li>
		</ul>
	</li>
	</ul>
	<p><strong>Dica:</strong>
	Nos relatórios, clique no título da coluna para mudar a ordenação.
	Clicando novamente a ordem é invertida.
	</p>
	<p><strong>Instruções:</strong>
	Salve esta página, use um editor de textos para colocar seus lançamentos e abra no navegador.
	</div>
	</div>

<!-- Tags -->
<div id="tagsArea">
	<div id="operabug">
	<div id="tagMultiAll">
		<input
		 	id="tagMultiAllCheck" type="checkbox" class="trigger"
			onClick="showReport()"><span
			id="tagMultiAllLabel" class="trigger"
			onClick="document.getElementById('tagMultiAllCheck').click()"></span>
	</div>
	<span id="tagsLabel">Tags:</span>
	<div id="tagList">
	</div>
	<input type="hidden" id="tagCount" value="0">
	</div> <!-- operabug -->
</div>

<!-- Report -->
<div id="report">
</div>

<!-- Chart -->
<div id="charts">
	<select id="chartcol" size="1" onChange="showReport()"></select>
	<div id="chart"></div>
</div>

<noscript>
<p>Sorry. No Javascript detected, it won't work.</p>
<p>Ops! Seu navegador está sem Javascript, sem ele não vai funcionar.</p>
</noscript>

</div> <!-- #content -->

<!-- modular -->
<iframe id="dataFrame" onLoad="iframeLoaded(this)">
	<p>Sorry. No iframes support detected, please use the all-in-one version.</p>
	<p>Ops! Seu navegador não entende iframes. Use a versão tudo-em-um.</p>
</iframe>

<!-- tudo-em-um / all-in-one -->
<pre id="data">

# Troque estes dados pelos seus, separados por TAB
# Repito: separados por TAB, e não espaços em branco
# A data é no formato ANO-MES-DIA

2009-05-01	-100	Saldo inicial da conta :(
2009-05-15	-74,23	mercado|
2009-05-15	- 1,99	nerd| Prestação do mouse 10/12
2009-05-23	-39,90	presente, livro| Livro "Horóscopo dos Duendes"

2009-06-03	-342,59	presente| Um Shrubbery
2009-06-11	 30,00	Ganhei a aposta com o Zé
2009-06-12	-35,00	presente, nerd| Poster colorido 3D do Tux em Ascii Art
2009-06-15	- 1,99	nerd| Prestação do mouse 11/12
2009-06-29	-95,67	mercado|

2009-07-12	-199,90	presente| Segway usado no Mercado Livre
2009-07-15	- 1,99	nerd| Prestação do mouse 12/12 (acabou!)

2009-08-20	-10,00	Carnê do Baú

# A ordem não importa, é possível deixar juntas as transações periódicas
2009-05-05	500	salario|
2009-06-05	500	salario|
2009-07-05	500	salario|
2009-08-05	500	salario|

2009-05-07	-25,00	luz|
2009-06-07	-20,00	luz|
2009-07-07	-29,00	luz|
2009-08-07	-25,00	luz|

2009-05-07	-20,00	agua|
2009-06-07	-17,80	agua|
2009-07-07	-32,37	agua|
2009-08-07	-30,00	agua|


# Transações futuras!
2009-12-31	+99,99	salario| Bônus

# Pagamentos e ganhos parcelados
2009-08-05	-500/5	nerd| Netbook usado comprado parcelado
2009-11-25	100/2	presente| Presente de Natal, metade Nov, metade Dez

# Pagamentos e ganhos recorrentes
2009-05-05	-200*6	aluguel| Aluguel da casa (seis meses)
2009-09-10	100*4	presente| O Zé vai me dar 100 pilas por mês até o fim do ano
