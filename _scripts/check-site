#!/bin/bash
# Check for errors on the generated site

set -eu

error() {
    echo "**** ERROR: $1"
    echo "$2" | head -n 40
    exit 1
}

# Make sure we are at the repository root
cd $(dirname "$0")
cd ..

# Enter the generated site folder
cd _site

relative_urls=$(
    # ./
    grep -r -i -E '(src|href)="\./' .
    grep -r -i -E '(src|href)="[^"]*/\./' .

    # ../
    grep -r -i -E '(src|href)="\.\./' .
    grep -r -i -E '(src|href)="[^"]*/\.\./' .
)

unquoted_attributes=$(
    # Grep for <tag foo=bar> instead of <tag foo="bar">
    grep -r -i -E '<[a-z]+ [^>]*[a-z]=[^"]' . |
        grep -F -v 'content="text/html; charset=utf-8"'
)

test -n "$relative_urls" && error "Do not use relative URLs" "$relative_urls"
test -n "$unquoted_attributes" && error "Unquoted HTML attributes" "$unquoted_attributes"
