#!/bin/bash
# Check for errors on the generated site

error() {
    echo
    echo "**** FAILED :("
    echo
    echo "$*" | head -n 40
    exit 1
}

# Make sure we are at the repository root
cd $(dirname "$0")
cd ..

# Enter the generated site folder
cd _site

# Do not use relative URLs in links and images
check_relative_urls() {
    local wrong

    wrong=$(
        # ./
        grep -r -i -E '(src|href)="\./' .
        grep -r -i -E '(src|href)="[^"]*/\./' .

        # ../
        grep -r -i -E '(src|href)="\.\./' .
        grep -r -i -E '(src|href)="[^"]*/\.\./' .
    )

    test -n "$wrong" && error "$wrong"
}


# Grep for <tag foo=bar> instead of <tag foo="bar">
check_unquoted_attributes() {
    local wrong

    wrong=$(
        grep -r -i -E '<[a-z]+ [^>]*[a-z]=[^"]' . |
            grep -F -i -v 'content="text/html; charset=utf-8"'
    )

    test -n "$wrong" && error "$wrong"
}

active_checks="
    check_unquoted_attributes
    check_relative_urls
"

for check in $active_checks
do
    echo "Running $check..."
    $check
done
